<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Why tensors? | DIPlib | a library for quantitative image analysis</title>
  <link rel="stylesheet" href="m-dip+documentation.compiled.css" />
  <link rel="icon" href="DIP_logo_32.png" type="image/png" />
  <link rel="search" type="application/opensearchdescription+xml" href="opensearch.xml" title="Search DIPlib documentation" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <span id="m-navbar-brand" class="m-col-t-8 m-col-m-none m-left-m">
        <a href="https://diplib.org">DIPlib</a><span class="m-breadcrumb">â”ƒ</span><a href="index.html" class="m-thin">a library for quantitative image analysis</a>      </span>
      <div class="m-col-t-4 m-hide-m m-text-right m-nopadr">
        <a href="#search" class="m-doc-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
          <path id="m-doc-search-icon-path" d="m6 0c-3.31 0-6 2.69-6 6 0 3.31 2.69 6 6 6 1.49 0 2.85-0.541 3.89-1.44-0.0164 0.338 0.147 0.759 0.5 1.15l3.22 3.79c0.552 0.614 1.45 0.665 2 0.115 0.55-0.55 0.499-1.45-0.115-2l-3.79-3.22c-0.392-0.353-0.812-0.515-1.15-0.5 0.895-1.05 1.44-2.41 1.44-3.89 0-3.31-2.69-6-6-6zm0 1.56a4.44 4.44 0 0 1 4.44 4.44 4.44 4.44 0 0 1-4.44 4.44 4.44 4.44 0 0 1-4.44-4.44 4.44 4.44 0 0 1 4.44-4.44z"/>
        </svg></a>
        <a id="m-navbar-show" href="#navigation" title="Show navigation"></a>
        <a id="m-navbar-hide" href="#" title="Hide navigation"></a>
      </div>
      <div id="m-navbar-collapse" class="m-col-t-12 m-show-m m-col-m-none m-right-m">
        <div class="m-row">
          <ol class="m-col-t-6 m-col-m-none">
            <li><a href="pages.html">Pages</a></li>
            <li><a href="modules.html">Modules</a></li>
          </ol>
          <ol class="m-col-t-6 m-col-m-none" start="3">
            <li><a href="classes.html">Classes</a></li>
            <li><a href="files.html">Files</a></li>
            <li class="m-show-m"><a href="#search" class="m-doc-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
              <use href="#m-doc-search-icon-path" />
            </svg></a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main><article>
  <div class="m-container m-container-inflatable">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <h1>
          Why tensors?
        </h1>
        <div class="m-block m-default">
          <h3>Contents</h3>
          <ul>
            <li><a href="#stain_unmixing">Stain unmixing</a></li>
            <li><a href="#structure_tensor">The structure tensor</a></li>
            <li><a href="#harris">The Harris corner detector</a></li>
            <li><a href="#optical_flow">Lucas-Kanade optical flow</a></li>
            <li><a href="#diffusion">Anisotropic diffusion</a></li>
          </ul>
        </div>
<p>Images in <em>DIPlib 3</em> have pixel values generalized to tensors. Currently only
tensors of order up to 2 are supported. Thus, pixel values can be scalar (0<sup>th</sup>-order
tensor), vector (1<sup>st</sup>-order) or matrix (2<sup>nd</sup> order). This covers all current
applications of multi-valued pixels, as far as we&rsquo;re aware. On this page we show
some examples of these applications that show the notational simplicity that comes
with the tensor representation. In each of the examples below, please think about
how an equivalent program would look if one did not have access to a tensor
representation.</p>
<h2 id="stain_unmixing">Stain unmixing</h2>
<p>In brightfield microscopy it is well-known that multiple stains on a slide generate
a linear mixture of those stains&rsquo; color vectors (see Ruifrok &amp; Johnston,
Anal Quant Cytol Histol 23(4):291-9, 2001, who unfortunately called it &ldquo;color
deconvolution&rdquo;, a name that has stuck even though this has nothing to do
with deconvolution). Given, for example, two stains imaged in an RGB image,
then the absorption <span class="m-math"><svg style="width: 0.567em; height: 0.538em; vertical-align: -0.013em;" viewBox=".16 -5.25 5.67 5.38">
<title>
\(a\)
</title>
<defs>
<path id='eq250-g1-48' d='M5.67-1.19L5.53-1.31L5.19-.98C4.82-.6 4.68-.49 4.57-.49C4.48-.49 4.41-.56 4.41-.64C4.41-.88 4.91-2.93 5.47-4.97C5.5-5.09 5.51-5.11 5.54-5.22L5.46-5.25L4.73-5.17L4.69-5.13L4.56-4.56C4.47-5 4.12-5.25 3.61-5.25C2.02-5.25 .2-3.08 .2-1.19C.2-.36 .66 .13 1.42 .13C2.25 .13 2.76-.26 3.81-1.74C3.56-.76 3.54-.67 3.54-.37C3.54-.02 3.68 .12 4.01 .12C4.49 .12 4.78-.11 5.67-1.19ZM4.35-4.26C4.35-3.26 3.74-1.86 2.93-.98C2.64-.66 2.24-.45 1.89-.45C1.46-.45 1.2-.79 1.2-1.33C1.2-1.98 1.62-3.14 2.12-3.89C2.6-4.6 3.13-4.99 3.62-4.99C3.64-4.99 3.66-4.99 3.68-4.99C4.09-4.97 4.35-4.68 4.35-4.26Z'/>
</defs>
<g id='eq250-page1'>
<use x='.16' y='0' xlink:href='#eq250-g1-48'/>
</g>
</svg></span> in each of the R, G and B channels is:</p>
<div class="m-math"><svg style="width: 13.695em; height: 4.342em;" viewBox="126.17 -43.5 136.95 43.42">
<title>
\[ \begin{bmatrix} a_R \\ a_G \\ a_B \end{bmatrix} =
   \begin{bmatrix} s_1^R &amp; s_2^R \\
                   s_1^G &amp; s_2^G \\
                   s_1^B &amp; s_2^B \end{bmatrix}
   \begin{bmatrix} d_1 \\ d_2 \end{bmatrix} = S \, d \]
</title>
<defs>
<path id='eq243-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<path id='eq243-g7-23' d='M4.71-1.75C4.71-2.38 4.44-2.71 3.61-3.07C4.23-3.21 4.48-3.32 4.76-3.56C5-3.77 5.14-4.06 5.14-4.42C5.14-5.25 4.52-5.7 3.39-5.7H1.14V-5.56C1.69-5.52 1.81-5.46 1.81-5.21C1.81-5.07 1.77-4.87 1.71-4.65L.64-.79C.48-.28 .42-.23-.07-.14V0H2.39C3.76 0 4.71-.71 4.71-1.75ZM3.76-1.78C3.76-.84 3.12-.26 2.05-.26C1.69-.26 1.49-.38 1.49-.63C1.49-.74 1.6-1.15 1.8-1.85L2.08-2.89C2.63-2.89 3-2.86 3.18-2.79C3.55-2.65 3.76-2.26 3.76-1.78ZM4.25-4.5C4.25-3.6 3.67-3.17 2.46-3.17H2.17L2.73-5.2C2.79-5.39 2.89-5.44 3.23-5.44C3.94-5.44 4.25-5.14 4.25-4.5Z'/>
<path id='eq243-g7-28' d='M6.31-2.65V-2.79H3.98V-2.65L4.24-2.62C4.52-2.59 4.66-2.51 4.66-2.35C4.66-2.16 4.61-1.93 4.44-1.35C4.24-.67 4.2-.57 4.1-.46C3.9-.27 3.57-.17 3.18-.17C2.05-.17 1.41-.81 1.41-1.96C1.41-3.03 1.84-4.15 2.53-4.87C2.93-5.28 3.47-5.52 4.04-5.52C4.6-5.52 5.07-5.29 5.35-4.9C5.49-4.67 5.56-4.48 5.6-4.09L5.76-4.06L6.18-5.78L6.05-5.82C5.9-5.61 5.76-5.52 5.53-5.52C5.43-5.52 5.35-5.54 5.14-5.61C4.72-5.75 4.33-5.82 3.97-5.82C2.13-5.82 .45-4.07 .45-2.15C.45-1.55 .71-.94 1.12-.52C1.56-.08 2.2 .16 2.96 .16C3.73 .16 4.36-.01 5.03-.38L5.46-2.02C5.6-2.51 5.74-2.61 6.31-2.65Z'/>
<path id='eq243-g7-39' d='M4.95 0V-.14C4.57-.17 4.39-.31 4.23-.77L3.42-2.91C4.09-3.06 4.38-3.18 4.69-3.46C4.98-3.71 5.14-4.05 5.14-4.45C5.14-5.26 4.5-5.7 3.32-5.7H1.15V-5.56C1.52-5.51 1.56-5.5 1.66-5.44C1.72-5.4 1.77-5.29 1.77-5.2C1.77-5.09 1.74-4.88 1.67-4.65L.59-.79C.44-.27 .38-.22-.11-.14V0H2.02V-.14C1.48-.21 1.42-.24 1.42-.55C1.42-.64 1.44-.72 1.53-1.05L2.02-2.87L2.59-2.83L3.66 0H4.95ZM4.22-4.46C4.22-3.6 3.66-3.15 2.57-3.15C2.41-3.15 2.34-3.16 2.12-3.2L2.69-5.2C2.74-5.38 2.86-5.44 3.14-5.44C3.86-5.44 4.22-5.12 4.22-4.46Z'/>
<path id='eq243-g7-40' d='M3.76-1.59C3.76-2.16 3.57-2.49 2.78-3.29C1.98-4.09 1.91-4.21 1.91-4.64C1.91-5.19 2.28-5.53 2.87-5.53C3.2-5.53 3.46-5.42 3.64-5.21C3.84-5 3.91-4.7 3.93-4.11L4.09-4.09L4.44-5.83H4.24C4.11-5.64 4.04-5.6 3.84-5.6C3.73-5.6 3.62-5.62 3.44-5.69C3.26-5.77 2.97-5.82 2.7-5.82C1.79-5.82 1.14-5.21 1.14-4.36C1.14-3.89 1.28-3.63 1.8-3.07C1.91-2.96 2.03-2.84 2.14-2.71L2.48-2.34C2.89-1.91 3-1.69 3-1.31C3-.65 2.52-.15 1.88-.15C1.14-.15 .6-.77 .6-1.62C.6-1.69 .6-1.72 .62-1.8L.45-1.82L.15 .13H.31C.37-.07 .46-.16 .64-.16C.73-.16 .86-.12 1.09-.04C1.49 .1 1.73 .16 2 .16C3 .16 3.76-.59 3.76-1.59Z'/>
<path id='eq243-g7-48' d='M4.16-.87L4.05-.96L3.81-.72C3.54-.44 3.43-.36 3.35-.36C3.28-.36 3.23-.41 3.23-.47C3.23-.65 3.6-2.15 4.01-3.64C4.04-3.73 4.04-3.75 4.06-3.83L4-3.85L3.47-3.79L3.44-3.76L3.35-3.35C3.28-3.67 3.02-3.85 2.65-3.85C1.48-3.85 .15-2.26 .15-.87C.15-.26 .48 .1 1.04 .1C1.65 .1 2.03-.19 2.79-1.28C2.61-.56 2.59-.49 2.59-.27C2.59-.02 2.7 .09 2.94 .09C3.29 .09 3.5-.08 4.16-.87ZM3.19-3.13C3.19-2.39 2.74-1.36 2.15-.72C1.94-.48 1.64-.33 1.39-.33C1.07-.33 .88-.58 .88-.98C.88-1.45 1.19-2.31 1.55-2.86C1.9-3.37 2.3-3.66 2.66-3.66C2.67-3.66 2.68-3.66 2.7-3.66C3-3.64 3.19-3.43 3.19-3.13Z'/>
<path id='eq243-g7-51' d='M4.15-.88L4.04-.97C3.56-.42 3.48-.35 3.33-.35C3.24-.35 3.17-.42 3.17-.52C3.17-.66 3.44-1.69 3.74-2.67L4.6-5.92L4.56-5.97C4.1-5.87 3.78-5.82 3.22-5.76V-5.62C3.7-5.6 3.76-5.57 3.76-5.39C3.76-5.27 3.76-5.24 3.63-4.78L3.25-3.35C3.18-3.71 3.02-3.85 2.68-3.85C1.55-3.85 .13-2.21 .13-.9C.13-.28 .48 .1 1.05 .1C1.64 .1 2.03-.18 2.62-1.06C2.52-.62 2.51-.48 2.51-.28C2.51-.04 2.65 .11 2.87 .11C3.24 .11 3.7-.24 4.15-.88ZM3.11-3.15C3.11-1.83 2.2-.32 1.4-.32C1.09-.32 .89-.55 .89-.9C.89-1.62 1.33-2.64 1.9-3.25C2.14-3.49 2.44-3.65 2.68-3.65C2.69-3.65 2.71-3.65 2.72-3.65C2.98-3.63 3.11-3.47 3.11-3.15Z'/>
<path id='eq243-g7-66' d='M2.66-1.04C2.66-1.38 2.47-1.76 2.06-2.26C1.73-2.67 1.59-2.94 1.59-3.18C1.59-3.48 1.77-3.65 2.08-3.65C2.53-3.65 2.79-3.33 2.88-2.65H3.02L3.2-3.86H3.07C3-3.74 2.94-3.7 2.81-3.7C2.74-3.7 2.66-3.72 2.5-3.76C2.28-3.83 2.16-3.85 2.01-3.85C1.36-3.85 .95-3.48 .95-2.89C.95-2.61 1.14-2.24 1.5-1.76C1.84-1.32 1.99-1.01 1.99-.76C1.99-.36 1.73-.09 1.35-.09C.86-.09 .59-.45 .45-1.28H.31L.14 .11H.28C.36-.03 .39-.07 .49-.07S.74-.03 .92 .01C1.12 .07 1.25 .1 1.4 .1C2.13 .1 2.66-.38 2.66-1.04Z'/>
<path id='eq243-g14-49' d='M3.44 0V-.13C2.75-.14 2.61-.23 2.61-.65V-5.89L2.54-5.9L.97-5.11V-4.99C1.07-5.03 1.17-5.07 1.21-5.08C1.36-5.14 1.51-5.18 1.6-5.18C1.78-5.18 1.86-5.05 1.86-4.77V-.81C1.86-.52 1.79-.32 1.65-.24C1.52-.17 1.4-.14 1.03-.13V0H3.44Z'/>
<path id='eq243-g14-50' d='M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z'/>
<use id='eq243-g10-40' xlink:href='#eq243-g7-40' transform='scale(1.36)'/>
<use id='eq243-g10-48' xlink:href='#eq243-g7-48' transform='scale(1.36)'/>
<use id='eq243-g10-51' xlink:href='#eq243-g7-51' transform='scale(1.36)'/>
<use id='eq243-g10-66' xlink:href='#eq243-g7-66' transform='scale(1.36)'/>
<path id='eq243-g4-20' d='M3.8 27.92V27.62H2.51C2.22 27.62 1.97 27.42 1.97 27.12V.12C1.97-.18 2.22-.39 2.51-.39H3.8V-.67H1.05V27.92H3.8Z'/>
<path id='eq243-g4-21' d='M3.16 27.92V-.67H.4V-.39H1.69C1.99-.39 2.24-.18 2.24 .12V27.12C2.24 27.42 1.99 27.62 1.69 27.62H.4V27.92H3.16Z'/>
<path id='eq243-g4-50' d='M3.92-6.54V-7.15H1.05V.26H1.97V-6.04C1.97-6.34 2.22-6.54 2.51-6.54H3.92Z'/>
<path id='eq243-g4-51' d='M3.28 .26V-7.15H.4V-6.54H1.81C2.11-6.54 2.36-6.34 2.36-6.04V.26H3.28Z'/>
<path id='eq243-g4-52' d='M3.92 0V-.61H2.51C2.22-.61 1.97-.81 1.97-1.11V-7.38H1.05V0H3.92Z'/>
<path id='eq243-g4-53' d='M3.28 0V-7.38H2.36V-1.11C2.36-.81 2.11-.61 1.81-.61H.4V0H3.28Z'/>
<path id='eq243-g4-54' d='M1.97 .14V-7.56H1.05V.14H1.97Z'/>
<path id='eq243-g4-55' d='M3.28 .13V-7.56H2.36V.13H3.28Z'/>
</defs>
<g id='eq243-page1'>
<use x='126.17' y='-36.13' xlink:href='#eq243-g4-50'/>
<use x='126.17' y='-28.96' xlink:href='#eq243-g4-54'/>
<use x='126.17' y='-21.78' xlink:href='#eq243-g4-54'/>
<use x='126.17' y='-14.61' xlink:href='#eq243-g4-54'/>
<use x='126.17' y='-7.44' xlink:href='#eq243-g4-54'/>
<use x='126.17' y='-.26' xlink:href='#eq243-g4-52'/>
<use x='131.11' y='-33.34' xlink:href='#eq243-g10-48'/>
<use x='137.91' y='-31.55' xlink:href='#eq243-g7-39'/>
<use x='130.67' y='-18.89' xlink:href='#eq243-g10-48'/>
<use x='137.07' y='-17.1' xlink:href='#eq243-g7-28'/>
<use x='131.18' y='-4.45' xlink:href='#eq243-g10-48'/>
<use x='137.94' y='-2.66' xlink:href='#eq243-g7-23'/>
<use x='144.48' y='-36.13' xlink:href='#eq243-g4-51'/>
<use x='144.48' y='-28.96' xlink:href='#eq243-g4-55'/>
<use x='144.48' y='-21.78' xlink:href='#eq243-g4-55'/>
<use x='144.48' y='-14.61' xlink:href='#eq243-g4-55'/>
<use x='144.48' y='-7.44' xlink:href='#eq243-g4-55'/>
<use x='144.48' y='-.26' xlink:href='#eq243-g4-53'/>
<use x='153.21' y='-18.71' xlink:href='#eq243-g1-61'/>
<use x='164.69' y='-36.13' xlink:href='#eq243-g4-50'/>
<use x='164.69' y='-28.96' xlink:href='#eq243-g4-54'/>
<use x='164.69' y='-21.78' xlink:href='#eq243-g4-54'/>
<use x='164.69' y='-14.61' xlink:href='#eq243-g4-54'/>
<use x='164.69' y='-7.44' xlink:href='#eq243-g4-54'/>
<use x='164.69' y='-.26' xlink:href='#eq243-g4-52'/>
<use x='169.78' y='-33.46' xlink:href='#eq243-g10-66'/>
<use x='175.11' y='-37.8' xlink:href='#eq243-g7-39'/>
<use x='174.67' y='-29.2' xlink:href='#eq243-g14-49'/>
<use x='192.4' y='-33.46' xlink:href='#eq243-g10-66'/>
<use x='197.72' y='-37.8' xlink:href='#eq243-g7-39'/>
<use x='197.29' y='-29.2' xlink:href='#eq243-g14-50'/>
<use x='169.34' y='-18.82' xlink:href='#eq243-g10-66'/>
<use x='174.27' y='-23.2' xlink:href='#eq243-g7-28'/>
<use x='174.23' y='-14.45' xlink:href='#eq243-g14-49'/>
<use x='191.95' y='-18.82' xlink:href='#eq243-g10-66'/>
<use x='196.88' y='-23.2' xlink:href='#eq243-g7-28'/>
<use x='196.84' y='-14.45' xlink:href='#eq243-g14-50'/>
<use x='169.85' y='-4.33' xlink:href='#eq243-g10-66'/>
<use x='175.14' y='-8.67' xlink:href='#eq243-g7-23'/>
<use x='174.74' y='-.08' xlink:href='#eq243-g14-49'/>
<use x='192.46' y='-4.33' xlink:href='#eq243-g10-66'/>
<use x='197.75' y='-8.67' xlink:href='#eq243-g7-23'/>
<use x='197.35' y='-.08' xlink:href='#eq243-g14-50'/>
<use x='204.29' y='-36.13' xlink:href='#eq243-g4-51'/>
<use x='204.29' y='-28.96' xlink:href='#eq243-g4-55'/>
<use x='204.29' y='-21.78' xlink:href='#eq243-g4-55'/>
<use x='204.29' y='-14.61' xlink:href='#eq243-g4-55'/>
<use x='204.29' y='-7.44' xlink:href='#eq243-g4-55'/>
<use x='204.29' y='-.26' xlink:href='#eq243-g4-53'/>
<use x='212.77' y='-35.58' xlink:href='#eq243-g4-20'/>
<use x='217.53' y='-26.12' xlink:href='#eq243-g10-51'/>
<use x='223.8' y='-24.32' xlink:href='#eq243-g14-49'/>
<use x='217.53' y='-11.67' xlink:href='#eq243-g10-51'/>
<use x='223.8' y='-9.88' xlink:href='#eq243-g14-50'/>
<use x='228.92' y='-35.58' xlink:href='#eq243-g4-21'/>
<use x='237.53' y='-18.71' xlink:href='#eq243-g1-61'/>
<use x='248.17' y='-18.71' xlink:href='#eq243-g10-40'/>
<use x='256.85' y='-18.71' xlink:href='#eq243-g10-51'/>
</g>
</svg></div>
<p>where <span class="m-math"><svg style="width: 0.850em; height: 1.002em; vertical-align: -0.190em;" viewBox=".3 -8.13 8.5 10.02">
<title>
\(d_i\)
</title>
<defs>
<path id='eq251-g1-51' d='M4.15-.88L4.04-.97C3.56-.42 3.48-.35 3.33-.35C3.24-.35 3.17-.42 3.17-.52C3.17-.66 3.44-1.69 3.74-2.67L4.6-5.92L4.56-5.97C4.1-5.87 3.78-5.82 3.22-5.76V-5.62C3.7-5.6 3.76-5.57 3.76-5.39C3.76-5.27 3.76-5.24 3.63-4.78L3.25-3.35C3.18-3.71 3.02-3.85 2.68-3.85C1.55-3.85 .13-2.21 .13-.9C.13-.28 .48 .1 1.05 .1C1.64 .1 2.03-.18 2.62-1.06C2.52-.62 2.51-.48 2.51-.28C2.51-.04 2.65 .11 2.87 .11C3.24 .11 3.7-.24 4.15-.88ZM3.11-3.15C3.11-1.83 2.2-.32 1.4-.32C1.09-.32 .89-.55 .89-.9C.89-1.62 1.33-2.64 1.9-3.25C2.14-3.49 2.44-3.65 2.68-3.65C2.69-3.65 2.71-3.65 2.72-3.65C2.98-3.63 3.11-3.47 3.11-3.15Z'/>
<path id='eq251-g1-56' d='M2.05-.9L1.94-1C1.56-.5 1.37-.31 1.22-.31C1.15-.31 1.08-.38 1.08-.45C1.08-.59 1.17-.85 1.22-1.02L1.99-3.83L1.97-3.85C1.08-3.69 .91-3.66 .57-3.63V-3.49C1.04-3.49 1.12-3.46 1.12-3.28C1.12-3.21 1.09-3.07 1.04-2.9L.62-1.35C.48-.83 .43-.58 .43-.4C.43-.08 .57 .1 .83 .1C1.24 .1 1.55-.17 2.05-.9ZM2.41-5.14C2.41-5.39 2.21-5.62 1.97-5.62S1.56-5.42 1.56-5.15C1.56-4.87 1.73-4.69 1.98-4.69C2.21-4.69 2.41-4.89 2.41-5.14Z'/>
<use id='eq251-g4-51' xlink:href='#eq251-g1-51' transform='scale(1.36)'/>
</defs>
<g id='eq251-page1'>
<use x='.3' y='0' xlink:href='#eq251-g4-51'/>
<use x='6.39' y='1.79' xlink:href='#eq251-g1-56'/>
</g>
</svg></span> are the optical densities of the stains at a particular point,
<span class="m-math"><svg style="width: 1.211em; height: 1.403em; vertical-align: -0.400em;" viewBox=".3 -10.04 12.11 14.03">
<title>
\(d_i^R\)
</title>
<defs>
<path id='eq252-g1-39' d='M4.95 0V-.14C4.57-.17 4.39-.31 4.23-.77L3.42-2.91C4.09-3.06 4.38-3.18 4.69-3.46C4.98-3.71 5.14-4.05 5.14-4.45C5.14-5.26 4.5-5.7 3.32-5.7H1.15V-5.56C1.52-5.51 1.56-5.5 1.66-5.44C1.72-5.4 1.77-5.29 1.77-5.2C1.77-5.09 1.74-4.88 1.67-4.65L.59-.79C.44-.27 .38-.22-.11-.14V0H2.02V-.14C1.48-.21 1.42-.24 1.42-.55C1.42-.64 1.44-.72 1.53-1.05L2.02-2.87L2.59-2.83L3.66 0H4.95ZM4.22-4.46C4.22-3.6 3.66-3.15 2.57-3.15C2.41-3.15 2.34-3.16 2.12-3.2L2.69-5.2C2.74-5.38 2.86-5.44 3.14-5.44C3.86-5.44 4.22-5.12 4.22-4.46Z'/>
<path id='eq252-g1-51' d='M4.15-.88L4.04-.97C3.56-.42 3.48-.35 3.33-.35C3.24-.35 3.17-.42 3.17-.52C3.17-.66 3.44-1.69 3.74-2.67L4.6-5.92L4.56-5.97C4.1-5.87 3.78-5.82 3.22-5.76V-5.62C3.7-5.6 3.76-5.57 3.76-5.39C3.76-5.27 3.76-5.24 3.63-4.78L3.25-3.35C3.18-3.71 3.02-3.85 2.68-3.85C1.55-3.85 .13-2.21 .13-.9C.13-.28 .48 .1 1.05 .1C1.64 .1 2.03-.18 2.62-1.06C2.52-.62 2.51-.48 2.51-.28C2.51-.04 2.65 .11 2.87 .11C3.24 .11 3.7-.24 4.15-.88ZM3.11-3.15C3.11-1.83 2.2-.32 1.4-.32C1.09-.32 .89-.55 .89-.9C.89-1.62 1.33-2.64 1.9-3.25C2.14-3.49 2.44-3.65 2.68-3.65C2.69-3.65 2.71-3.65 2.72-3.65C2.98-3.63 3.11-3.47 3.11-3.15Z'/>
<path id='eq252-g1-56' d='M2.05-.9L1.94-1C1.56-.5 1.37-.31 1.22-.31C1.15-.31 1.08-.38 1.08-.45C1.08-.59 1.17-.85 1.22-1.02L1.99-3.83L1.97-3.85C1.08-3.69 .91-3.66 .57-3.63V-3.49C1.04-3.49 1.12-3.46 1.12-3.28C1.12-3.21 1.09-3.07 1.04-2.9L.62-1.35C.48-.83 .43-.58 .43-.4C.43-.08 .57 .1 .83 .1C1.24 .1 1.55-.17 2.05-.9ZM2.41-5.14C2.41-5.39 2.21-5.62 1.97-5.62S1.56-5.42 1.56-5.15C1.56-4.87 1.73-4.69 1.98-4.69C2.21-4.69 2.41-4.89 2.41-5.14Z'/>
<use id='eq252-g4-51' xlink:href='#eq252-g1-51' transform='scale(1.36)'/>
</defs>
<g id='eq252-page1'>
<use x='.3' y='0' xlink:href='#eq252-g4-51'/>
<use x='7.28' y='-4.34' xlink:href='#eq252-g1-39'/>
<use x='6.39' y='3.89' xlink:href='#eq252-g1-56'/>
</g>
</svg></span> is the absorption of stain <span class="m-math"><svg style="width: 0.329em; height: 0.779em; vertical-align: -0.013em;" viewBox="-.24 -7.66 3.29 7.79">
<title>
\(i\)
</title>
<defs>
<path id='eq253-g1-56' d='M2.8-1.23L2.64-1.36C2.13-.68 1.87-.43 1.67-.43C1.57-.43 1.48-.51 1.48-.61C1.48-.8 1.6-1.16 1.67-1.39L2.72-5.23L2.68-5.25C1.48-5.03 1.24-4.99 .77-4.95V-4.76C1.42-4.75 1.52-4.72 1.52-4.48C1.52-4.38 1.49-4.18 1.42-3.95L.85-1.85C.66-1.13 .58-.79 .58-.55C.58-.11 .77 .13 1.13 .13C1.69 .13 2.12-.23 2.8-1.23ZM3.29-7C3.29-7.35 3.01-7.66 2.69-7.66S2.13-7.4 2.13-7.03C2.13-6.65 2.36-6.4 2.7-6.4C3.01-6.4 3.29-6.67 3.29-7Z'/>
</defs>
<g id='eq253-page1'>
<use x='-.24' y='0' xlink:href='#eq253-g1-56'/>
</g>
</svg></span> in the red channel, etc. The actual
intensity measured by the camera is the transmittance <span class="m-math"><svg style="width: 0.353em; height: 0.663em; vertical-align: -0.013em;" viewBox="-.05 -6.5 3.53 6.63">
<title>
\(t\)
</title>
<defs>
<path id='eq254-g1-67' d='M3.53-5.1H2.57L2.91-6.32C2.92-6.35 2.92-6.37 2.92-6.38C2.92-6.47 2.88-6.5 2.82-6.5C2.75-6.5 2.72-6.49 2.64-6.4C1.51-4.92 .68-5.17 .68-4.79C.68-4.78 .68-4.75 .69-4.72H1.57L.71-1.44C.68-1.29 .44-.55 .44-.32C.44-.06 .69 .13 1.01 .13C1.56 .13 1.95-.2 2.7-1.31L2.55-1.39C1.97-.64 1.77-.45 1.58-.45C1.48-.45 1.41-.55 1.41-.69C1.41-.7 1.41-.71 1.42-.75L2.47-4.72H3.47L3.53-5.1Z'/>
</defs>
<g id='eq254-page1'>
<use x='-.05' y='0' xlink:href='#eq254-g1-67'/>
</g>
</svg></span>, given by</p>
<div class="m-math"><svg style="width: 4.157em; height: 0.896em;" viewBox="172.94 -8.96 41.57 8.96">
<title>
\[ t = -10^a \]
</title>
<defs>
<path id='eq244-g4-0' d='M6.84-2.73V-3.39H.74V-2.73H6.84Z'/>
<path id='eq244-g7-48' d='M4.16-.87L4.05-.96L3.81-.72C3.54-.44 3.43-.36 3.35-.36C3.28-.36 3.23-.41 3.23-.47C3.23-.65 3.6-2.15 4.01-3.64C4.04-3.73 4.04-3.75 4.06-3.83L4-3.85L3.47-3.79L3.44-3.76L3.35-3.35C3.28-3.67 3.02-3.85 2.65-3.85C1.48-3.85 .15-2.26 .15-.87C.15-.26 .48 .1 1.04 .1C1.65 .1 2.03-.19 2.79-1.28C2.61-.56 2.59-.49 2.59-.27C2.59-.02 2.7 .09 2.94 .09C3.29 .09 3.5-.08 4.16-.87ZM3.19-3.13C3.19-2.39 2.74-1.36 2.15-.72C1.94-.48 1.64-.33 1.39-.33C1.07-.33 .88-.58 .88-.98C.88-1.45 1.19-2.31 1.55-2.86C1.9-3.37 2.3-3.66 2.66-3.66C2.67-3.66 2.68-3.66 2.7-3.66C3-3.64 3.19-3.43 3.19-3.13Z'/>
<path id='eq244-g7-67' d='M2.59-3.74H1.89L2.13-4.64C2.14-4.66 2.14-4.67 2.14-4.68C2.14-4.74 2.11-4.77 2.07-4.77C2.02-4.77 1.99-4.76 1.94-4.69C1.11-3.61 .5-3.79 .5-3.51C.5-3.5 .5-3.49 .51-3.46H1.15L.52-1.06C.5-.94 .32-.4 .32-.24C.32-.04 .51 .1 .74 .1C1.14 .1 1.43-.15 1.98-.96L1.87-1.02C1.44-.47 1.3-.33 1.16-.33C1.08-.33 1.03-.4 1.03-.51C1.03-.52 1.03-.52 1.04-.55L1.81-3.46H2.54L2.59-3.74Z'/>
<path id='eq244-g14-48' d='M5.67-3.93C5.67-6.37 4.59-8.05 3.03-8.05C2.37-8.05 1.87-7.85 1.43-7.43C.74-6.77 .29-5.4 .29-4C.29-2.7 .68-1.31 1.24-.64C1.68-.12 2.29 .17 2.98 .17C3.59 .17 4.1-.04 4.53-.45C5.22-1.11 5.67-2.49 5.67-3.93ZM4.53-3.91C4.53-1.42 4-.14 2.98-.14S1.43-1.42 1.43-3.89C1.43-6.42 1.97-7.74 2.99-7.74C3.99-7.74 4.53-6.4 4.53-3.91Z'/>
<path id='eq244-g14-49' d='M4.69 0V-.18C3.75-.19 3.56-.31 3.56-.88V-8.03L3.47-8.05L1.32-6.97V-6.8C1.46-6.86 1.6-6.91 1.64-6.93C1.86-7.02 2.06-7.06 2.18-7.06C2.43-7.06 2.54-6.88 2.54-6.5V-1.11C2.54-.71 2.44-.44 2.25-.33C2.07-.23 1.91-.19 1.41-.18V0H4.69Z'/>
<path id='eq244-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<use id='eq244-g10-67' xlink:href='#eq244-g7-67' transform='scale(1.36)'/>
</defs>
<g id='eq244-page1'>
<use x='172.94' y='-.17' xlink:href='#eq244-g10-67'/>
<use x='180.28' y='-.17' xlink:href='#eq244-g1-61'/>
<use x='190.68' y='-.17' xlink:href='#eq244-g4-0'/>
<use x='198.28' y='-.17' xlink:href='#eq244-g14-49'/>
<use x='204.26' y='-.17' xlink:href='#eq244-g14-48'/>
<use x='210.35' y='-5.1' xlink:href='#eq244-g7-48'/>
</g>
</svg></div>
<p>(as a fraction of the incident light intensity);
see <a href="https://en.wikipedia.org/wiki/Beerâ€“Lambert_law">Beer-Lambert law</a>.</p>
<p>Thus, given <code>img</code>, an RGB image recorded in a brightfield microscope, the intensity
of the background <span class="m-math"><svg style="width: 0.467em; height: 0.778em; vertical-align: -0.000em;" viewBox=".39 -7.78 4.67 7.78">
<title>
\(I\)
</title>
<defs>
<path id='eq255-g1-30' d='M2.81 0V-.19C2.13-.27 2-.35 2-.68C2-.92 2.02-1.04 2.13-1.43L3.6-6.71C3.81-7.4 3.88-7.47 4.57-7.59V-7.78H1.63V-7.59C2.32-7.5 2.47-7.42 2.47-7.07C2.47-6.9 2.43-6.66 2.33-6.34L.87-1.07C.66-.38 .57-.31-.1-.19V0H2.81Z'/>
</defs>
<g id='eq255-page1'>
<use x='.49' y='0' xlink:href='#eq255-g1-30'/>
</g>
</svg></span>, and the mixing matrix <span class="m-math"><svg style="width: 0.605em; height: 0.816em; vertical-align: -0.022em;" viewBox=".24 -7.94 6.05 8.16">
<title>
\(S\)
</title>
<defs>
<path id='eq256-g1-40' d='M5.13-2.17C5.13-2.94 4.87-3.39 3.79-4.49C2.7-5.57 2.61-5.74 2.61-6.32C2.61-7.07 3.11-7.54 3.92-7.54C4.36-7.54 4.72-7.4 4.97-7.11C5.24-6.81 5.34-6.41 5.36-5.61L5.57-5.57L6.05-7.94H5.78C5.61-7.69 5.5-7.63 5.24-7.63C5.09-7.63 4.94-7.67 4.69-7.77C4.44-7.87 4.05-7.93 3.68-7.93C2.44-7.93 1.56-7.11 1.56-5.94C1.56-5.3 1.74-4.95 2.45-4.19C2.61-4.04 2.76-3.87 2.92-3.69L3.38-3.19C3.94-2.61 4.1-2.3 4.1-1.79C4.1-.88 3.44-.2 2.56-.2C1.56-.2 .82-1.05 .82-2.22C.82-2.3 .82-2.35 .85-2.45L.61-2.48L.2 .18H.42C.5-.1 .63-.21 .87-.21C1-.21 1.17-.17 1.49-.06C2.04 .14 2.36 .21 2.73 .21C4.1 .21 5.13-.81 5.13-2.17Z'/>
</defs>
<g id='eq256-page1'>
<use x='.24' y='0' xlink:href='#eq256-g1-40'/>
</g>
</svg></span>, you would follow the steps above
in reverse:</p>
<div class="m-code"><pre><span></span><span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">I</span><span class="p">{</span> <span class="n">I_R</span><span class="p">,</span> <span class="n">I_G</span><span class="p">,</span> <span class="n">I_B</span> <span class="p">};</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">t</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Log10</span><span class="p">(</span> <span class="o">-</span><span class="n">img</span> <span class="o">/</span> <span class="n">I</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">S</span><span class="p">{</span> <span class="n">S_1R</span><span class="p">,</span> <span class="n">S_1G</span><span class="p">,</span> <span class="n">S_1B</span><span class="p">,</span> <span class="n">S_2R</span><span class="p">,</span> <span class="n">S_2G</span><span class="p">,</span> <span class="n">S_2B</span> <span class="p">};</span>
<span class="n">S</span><span class="p">.</span><span class="n">ReshapeTensor</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">U</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">PseudoInverse</span><span class="p">(</span> <span class="n">S</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">d</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="n">t</span><span class="p">;</span>
</pre></div>

<p>Note that the most verbose part of the code above is to create the 0D (single-pixel)
images <code>S</code> and <code>I</code>, corresponding to the mixing matrix <span class="m-math"><svg style="width: 0.605em; height: 0.816em; vertical-align: -0.022em;" viewBox=".24 -7.94 6.05 8.16">
<title>
\(S\)
</title>
<defs>
<path id='eq257-g1-40' d='M5.13-2.17C5.13-2.94 4.87-3.39 3.79-4.49C2.7-5.57 2.61-5.74 2.61-6.32C2.61-7.07 3.11-7.54 3.92-7.54C4.36-7.54 4.72-7.4 4.97-7.11C5.24-6.81 5.34-6.41 5.36-5.61L5.57-5.57L6.05-7.94H5.78C5.61-7.69 5.5-7.63 5.24-7.63C5.09-7.63 4.94-7.67 4.69-7.77C4.44-7.87 4.05-7.93 3.68-7.93C2.44-7.93 1.56-7.11 1.56-5.94C1.56-5.3 1.74-4.95 2.45-4.19C2.61-4.04 2.76-3.87 2.92-3.69L3.38-3.19C3.94-2.61 4.1-2.3 4.1-1.79C4.1-.88 3.44-.2 2.56-.2C1.56-.2 .82-1.05 .82-2.22C.82-2.3 .82-2.35 .85-2.45L.61-2.48L.2 .18H.42C.5-.1 .63-.21 .87-.21C1-.21 1.17-.17 1.49-.06C2.04 .14 2.36 .21 2.73 .21C4.1 .21 5.13-.81 5.13-2.17Z'/>
</defs>
<g id='eq257-page1'>
<use x='.24' y='0' xlink:href='#eq257-g1-40'/>
</g>
</svg></span> and the background intensity
vector <span class="m-math"><svg style="width: 0.467em; height: 0.778em; vertical-align: -0.000em;" viewBox=".39 -7.78 4.67 7.78">
<title>
\(I\)
</title>
<defs>
<path id='eq258-g1-30' d='M2.81 0V-.19C2.13-.27 2-.35 2-.68C2-.92 2.02-1.04 2.13-1.43L3.6-6.71C3.81-7.4 3.88-7.47 4.57-7.59V-7.78H1.63V-7.59C2.32-7.5 2.47-7.42 2.47-7.07C2.47-6.9 2.43-6.66 2.33-6.34L.87-1.07C.66-.38 .57-.31-.1-.19V0H2.81Z'/>
</defs>
<g id='eq258-page1'>
<use x='.49' y='0' xlink:href='#eq258-g1-30'/>
</g>
</svg></span>. These are a single pixel because the same properties are valid across
the image. In the arithmetic operations, singleton-expansion causes these 0D images
to be expanded to the size of the image <code>img</code>, such that each pixel is multiplied
by the same matrix (though this expansion happens implicitly, there&rsquo;s not actually such an
image created in memory). Next, note that the operation <code>img / I</code> is a per-element
division, such that <code>img[0]</code> (red channel) is divided by <code>I[0]</code>, <code>img[1]</code> by <code>I[1]</code>,
and <code>img[2]</code> by <code>I[2]</code>. In contrast, <code>U * t</code> is a matrix multiplication.</p>
<p>The above is implemented in the functions <a href="microscopy.html#dip-BeerLambertMapping-dip-Image-CL-dip-Image-L-Image-Pixel-CL"><code>dip::BeerLambertMapping</code></a> and <a href="microscopy.html#dip-UnmixStains-dip-Image-CL-dip-Image-L-std-vector&lt;Image-Pixel&gt;-CL"><code>dip::UnmixStains</code></a>.</p>
<h2 id="structure_tensor">The structure tensor</h2>
<p>The structure tensor (see <a href="https://en.wikipedia.org/wiki/Structure_tensor">Wikipedia</a>)
is defined by the gradient of the image:</p>
<div class="m-math"><svg style="width: 14.356em; height: 3.573em;" viewBox="121.54 -35.96 143.56 35.73">
<title>
\[ S = \overline{(\nabla I)(\nabla I)^T} = \begin{bmatrix}
       \overline{I_x^2} &amp; \overline{I_x I_y} \\
       \overline{I_x I_y} &amp; \overline{I_y^2} \end{bmatrix} \]
</title>
<defs>
<path id='eq245-g17-50' d='M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z'/>
<path id='eq245-g10-30' d='M2.06 0V-.14C1.56-.2 1.47-.25 1.47-.5C1.47-.67 1.48-.76 1.56-1.05L2.64-4.92C2.79-5.42 2.85-5.48 3.35-5.56V-5.7H1.2V-5.56C1.7-5.5 1.81-5.44 1.81-5.19C1.81-5.06 1.78-4.88 1.71-4.65L.64-.79C.48-.28 .42-.23-.07-.14V0H2.06Z'/>
<path id='eq245-g10-40' d='M3.76-1.59C3.76-2.16 3.57-2.49 2.78-3.29C1.98-4.09 1.91-4.21 1.91-4.64C1.91-5.19 2.28-5.53 2.87-5.53C3.2-5.53 3.46-5.42 3.64-5.21C3.84-5 3.91-4.7 3.93-4.11L4.09-4.09L4.44-5.83H4.24C4.11-5.64 4.04-5.6 3.84-5.6C3.73-5.6 3.62-5.62 3.44-5.69C3.26-5.77 2.97-5.82 2.7-5.82C1.79-5.82 1.14-5.21 1.14-4.36C1.14-3.89 1.28-3.63 1.8-3.07C1.91-2.96 2.03-2.84 2.14-2.71L2.48-2.34C2.89-1.91 3-1.69 3-1.31C3-.65 2.52-.15 1.88-.15C1.14-.15 .6-.77 .6-1.62C.6-1.69 .6-1.72 .62-1.8L.45-1.82L.15 .13H.31C.37-.07 .46-.16 .64-.16C.73-.16 .86-.12 1.09-.04C1.49 .1 1.73 .16 2 .16C3 .16 3.76-.59 3.76-1.59Z'/>
<path id='eq245-g10-41' d='M5.53-5.7H.88L.52-4.36L.67-4.32C1.11-5.22 1.39-5.4 2.57-5.4C2.63-5.4 2.69-5.4 2.75-5.4L1.49-.79C1.35-.32 1.14-.18 .57-.14V0H3.1V-.14L2.77-.17C2.41-.19 2.31-.27 2.31-.54C2.31-.65 2.33-.73 2.42-1.05L3.63-5.4H4.11C4.74-5.4 5.02-5.18 5.02-4.69C5.02-4.58 5.01-4.45 5-4.3L5.14-4.28L5.53-5.7Z'/>
<path id='eq245-g10-71' d='M3.63-.9L3.51-.97C3.44-.88 3.4-.84 3.32-.73C3.12-.47 3.02-.38 2.91-.38C2.79-.38 2.71-.5 2.65-.74C2.63-.82 2.62-.86 2.61-.88C2.4-1.7 2.3-2.17 2.3-2.31C2.68-2.98 3-3.36 3.15-3.36C3.21-3.36 3.28-3.34 3.36-3.29C3.47-3.23 3.53-3.21 3.61-3.21C3.78-3.21 3.9-3.35 3.9-3.53C3.9-3.72 3.76-3.85 3.55-3.85C3.16-3.85 2.84-3.54 2.23-2.6L2.13-3.08C2.01-3.68 1.91-3.85 1.68-3.85C1.48-3.85 1.2-3.78 .66-3.6L.56-3.56L.59-3.43L.74-3.47C.91-3.51 1.01-3.53 1.08-3.53C1.3-3.53 1.35-3.45 1.48-2.93L1.73-1.85L1.01-.83C.83-.57 .66-.41 .57-.41C.52-.41 .43-.44 .34-.49C.23-.55 .14-.58 .06-.58C-.11-.58-.24-.45-.24-.27C-.24-.04-.07 .1 .2 .1S.58 .02 1.01-.51L1.8-1.54L2.06-.49C2.17-.03 2.29 .1 2.57 .1C2.9 .1 3.13-.11 3.63-.9Z'/>
<path id='eq245-g10-72' d='M3.72-3.37C3.72-3.63 3.5-3.85 3.24-3.85C3.04-3.85 2.9-3.72 2.9-3.53C2.9-3.39 2.97-3.3 3.14-3.19C3.31-3.09 3.37-3.01 3.37-2.89C3.37-2.54 3.06-1.87 2.31-.63L2.13-1.64C2-2.42 1.51-3.85 1.38-3.85H1.35L1.27-3.84L.41-3.69L.13-3.64V-3.49C.24-3.52 .31-3.53 .4-3.53C.75-3.53 .91-3.4 1.07-2.97C1.31-2.38 1.79-.42 1.79-.07C1.79 .03 1.76 .13 1.7 .24C1.63 .35 1.24 .86 1.08 1.03C.88 1.25 .78 1.32 .66 1.32C.6 1.32 .55 1.29 .45 1.22C.32 1.12 .24 1.07 .13 1.07C-.06 1.07-.21 1.22-.21 1.41C-.21 1.64-.03 1.8 .24 1.8C.73 1.8 1.68 .79 2.58-.71C3.31-1.91 3.72-2.87 3.72-3.37Z'/>
<path id='eq245-g7-114' d='M7.49-8.05H.37L3.88 0H4.12L7.49-8.05ZM6.5-7.02L4.31-1.73L2.11-7.02H6.5Z'/>
<path id='eq245-g7-185' d='M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z'/>
<path id='eq245-g7-186' d='M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z'/>
<path id='eq245-g4-34' d='M3.92 35.06V34.78H2.51C2.22 34.78 1.97 34.58 1.97 34.28V.12C1.97-.18 2.22-.38 2.51-.38H3.92V-.67H1.05V35.06H3.92Z'/>
<path id='eq245-g4-35' d='M3.28 35.06V-.67H.4V-.38H1.81C2.11-.38 2.36-.18 2.36 .12V34.28C2.36 34.58 2.11 34.78 1.81 34.78H.4V35.06H3.28Z'/>
<path id='eq245-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<use id='eq245-g13-30' xlink:href='#eq245-g10-30' transform='scale(1.36)'/>
<use id='eq245-g13-40' xlink:href='#eq245-g10-40' transform='scale(1.36)'/>
</defs>
<g id='eq245-page1'>
<use x='121.54' y='-14.91' xlink:href='#eq245-g13-40'/>
<use x='131.25' y='-14.91' xlink:href='#eq245-g1-61'/>
<rect x='141.64' y='-26.77' height='.67' width='52.22'/>
<use x='142.24' y='-14.91' xlink:href='#eq245-g7-185'/>
<use x='146.82' y='-14.91' xlink:href='#eq245-g7-114'/>
<use x='155.37' y='-14.91' xlink:href='#eq245-g13-30'/>
<use x='160.22' y='-14.91' xlink:href='#eq245-g7-186'/>
<use x='165.4' y='-14.91' xlink:href='#eq245-g7-185'/>
<use x='169.98' y='-14.91' xlink:href='#eq245-g7-114'/>
<use x='178.53' y='-14.91' xlink:href='#eq245-g13-30'/>
<use x='183.38' y='-14.91' xlink:href='#eq245-g7-186'/>
<use x='187.65' y='-18.36' xlink:href='#eq245-g10-41'/>
<use x='197.19' y='-14.91' xlink:href='#eq245-g1-61'/>
<use x='208.66' y='-35.29' xlink:href='#eq245-g4-34'/>
<rect x='217.72' y='-35.13' height='.67' width='10.23'/>
<use x='218.21' y='-22.31' xlink:href='#eq245-g13-30'/>
<use x='223.07' y='-26.53' xlink:href='#eq245-g17-50'/>
<use x='222.37' y='-20.06' xlink:href='#eq245-g10-71'/>
<rect x='242.39' y='-32.81' height='.67' width='19.19'/>
<use x='242.88' y='-22.31' xlink:href='#eq245-g13-30'/>
<use x='247.04' y='-20.52' xlink:href='#eq245-g10-71'/>
<use x='252.35' y='-22.31' xlink:href='#eq245-g13-30'/>
<use x='256.86' y='-20.52' xlink:href='#eq245-g10-72'/>
<rect x='213.24' y='-14.99' height='.67' width='19.19'/>
<use x='213.73' y='-4.5' xlink:href='#eq245-g13-30'/>
<use x='217.89' y='-2.7' xlink:href='#eq245-g10-71'/>
<use x='223.2' y='-4.5' xlink:href='#eq245-g13-30'/>
<use x='227.71' y='-2.7' xlink:href='#eq245-g10-72'/>
<rect x='246.88' y='-17.31' height='.67' width='10.23'/>
<use x='247.37' y='-4.5' xlink:href='#eq245-g13-30'/>
<use x='252.22' y='-8.72' xlink:href='#eq245-g17-50'/>
<use x='251.88' y='-2.24' xlink:href='#eq245-g10-72'/>
<use x='261.83' y='-35.29' xlink:href='#eq245-g4-35'/>
</g>
</svg></div>
<p>where <span class="m-math"><svg style="width: 0.816em; height: 0.967em; vertical-align: -0.190em;" viewBox=".39 -7.78 8.16 9.67">
<title>
\(I_x\)
</title>
<defs>
<path id='eq259-g1-30' d='M2.06 0V-.14C1.56-.2 1.47-.25 1.47-.5C1.47-.67 1.48-.76 1.56-1.05L2.64-4.92C2.79-5.42 2.85-5.48 3.35-5.56V-5.7H1.2V-5.56C1.7-5.5 1.81-5.44 1.81-5.19C1.81-5.06 1.78-4.88 1.71-4.65L.64-.79C.48-.28 .42-.23-.07-.14V0H2.06Z'/>
<path id='eq259-g1-71' d='M3.63-.9L3.51-.97C3.44-.88 3.4-.84 3.32-.73C3.12-.47 3.02-.38 2.91-.38C2.79-.38 2.71-.5 2.65-.74C2.63-.82 2.62-.86 2.61-.88C2.4-1.7 2.3-2.17 2.3-2.31C2.68-2.98 3-3.36 3.15-3.36C3.21-3.36 3.28-3.34 3.36-3.29C3.47-3.23 3.53-3.21 3.61-3.21C3.78-3.21 3.9-3.35 3.9-3.53C3.9-3.72 3.76-3.85 3.55-3.85C3.16-3.85 2.84-3.54 2.23-2.6L2.13-3.08C2.01-3.68 1.91-3.85 1.68-3.85C1.48-3.85 1.2-3.78 .66-3.6L.56-3.56L.59-3.43L.74-3.47C.91-3.51 1.01-3.53 1.08-3.53C1.3-3.53 1.35-3.45 1.48-2.93L1.73-1.85L1.01-.83C.83-.57 .66-.41 .57-.41C.52-.41 .43-.44 .34-.49C.23-.55 .14-.58 .06-.58C-.11-.58-.24-.45-.24-.27C-.24-.04-.07 .1 .2 .1S.58 .02 1.01-.51L1.8-1.54L2.06-.49C2.17-.03 2.29 .1 2.57 .1C2.9 .1 3.13-.11 3.63-.9Z'/>
<use id='eq259-g4-30' xlink:href='#eq259-g1-30' transform='scale(1.36)'/>
</defs>
<g id='eq259-page1'>
<use x='.49' y='0' xlink:href='#eq259-g4-30'/>
<use x='4.65' y='1.79' xlink:href='#eq259-g1-71'/>
</g>
</svg></span> is the partial derivative of the image <span class="m-math"><svg style="width: 0.467em; height: 0.778em; vertical-align: -0.000em;" viewBox=".39 -7.78 4.67 7.78">
<title>
\(I\)
</title>
<defs>
<path id='eq260-g1-30' d='M2.81 0V-.19C2.13-.27 2-.35 2-.68C2-.92 2.02-1.04 2.13-1.43L3.6-6.71C3.81-7.4 3.88-7.47 4.57-7.59V-7.78H1.63V-7.59C2.32-7.5 2.47-7.42 2.47-7.07C2.47-6.9 2.43-6.66 2.33-6.34L.87-1.07C.66-.38 .57-.31-.1-.19V0H2.81Z'/>
</defs>
<g id='eq260-page1'>
<use x='.49' y='0' xlink:href='#eq260-g1-30'/>
</g>
</svg></span> in the <span class="m-math"><svg style="width: 0.565em; height: 0.538em; vertical-align: -0.013em;" viewBox="-.32 -5.25 5.65 5.38">
<title>
\(x\)
</title>
<defs>
<path id='eq261-g1-71' d='M4.95-1.23L4.79-1.32C4.69-1.2 4.63-1.14 4.53-1C4.25-.64 4.12-.52 3.97-.52C3.8-.52 3.69-.68 3.61-1.01C3.59-1.12 3.57-1.18 3.56-1.2C3.28-2.32 3.13-2.97 3.13-3.14C3.66-4.06 4.09-4.59 4.3-4.59C4.37-4.59 4.48-4.55 4.59-4.49C4.73-4.41 4.81-4.38 4.92-4.38C5.16-4.38 5.32-4.56 5.32-4.81C5.32-5.07 5.12-5.25 4.84-5.25C4.31-5.25 3.87-4.82 3.04-3.55L2.91-4.2C2.74-5.01 2.61-5.25 2.29-5.25C2.01-5.25 1.63-5.16 .89-4.91L.76-4.86L.81-4.68L1.01-4.73C1.24-4.79 1.38-4.81 1.48-4.81C1.77-4.81 1.85-4.7 2.01-3.99L2.36-2.53L1.38-1.13C1.13-.77 .91-.56 .77-.56C.7-.56 .58-.6 .46-.67C.31-.75 .19-.79 .08-.79C-.15-.79-.32-.61-.32-.37C-.32-.06-.1 .13 .27 .13S.79 .02 1.38-.69L2.45-2.1L2.81-.67C2.97-.05 3.12 .13 3.5 .13C3.95 .13 4.26-.15 4.95-1.23Z'/>
</defs>
<g id='eq261-page1'>
<use x='0' y='0' xlink:href='#eq261-g1-71'/>
</g>
</svg></span> direction, and the
overline indicates local averaging. The equation above shows the
structure tensor for a 2D image, but the expression on the left is valid for
any number of dimensions. The eigenvalues of <span class="m-math"><svg style="width: 0.605em; height: 0.816em; vertical-align: -0.022em;" viewBox=".24 -7.94 6.05 8.16">
<title>
\(S\)
</title>
<defs>
<path id='eq262-g1-40' d='M5.13-2.17C5.13-2.94 4.87-3.39 3.79-4.49C2.7-5.57 2.61-5.74 2.61-6.32C2.61-7.07 3.11-7.54 3.92-7.54C4.36-7.54 4.72-7.4 4.97-7.11C5.24-6.81 5.34-6.41 5.36-5.61L5.57-5.57L6.05-7.94H5.78C5.61-7.69 5.5-7.63 5.24-7.63C5.09-7.63 4.94-7.67 4.69-7.77C4.44-7.87 4.05-7.93 3.68-7.93C2.44-7.93 1.56-7.11 1.56-5.94C1.56-5.3 1.74-4.95 2.45-4.19C2.61-4.04 2.76-3.87 2.92-3.69L3.38-3.19C3.94-2.61 4.1-2.3 4.1-1.79C4.1-.88 3.44-.2 2.56-.2C1.56-.2 .82-1.05 .82-2.22C.82-2.3 .82-2.35 .85-2.45L.61-2.48L.2 .18H.42C.5-.1 .63-.21 .87-.21C1-.21 1.17-.17 1.49-.06C2.04 .14 2.36 .21 2.73 .21C4.1 .21 5.13-.81 5.13-2.17Z'/>
</defs>
<g id='eq262-page1'>
<use x='.24' y='0' xlink:href='#eq262-g1-40'/>
</g>
</svg></span> describe the local neighborhood
of a pixel. If we sort the eigenvalues such that <span class="m-math"><svg style="width: 3.702em; height: 0.959em; vertical-align: -0.180em;" viewBox="-.16 -7.8 37.02 9.59">
<title>
\(\lambda_1 &gt; \lambda_2\)
</title>
<defs>
<path id='eq263-g5-49' d='M3.44 0V-.13C2.75-.14 2.61-.23 2.61-.65V-5.89L2.54-5.9L.97-5.11V-4.99C1.07-5.03 1.17-5.07 1.21-5.08C1.36-5.14 1.51-5.18 1.6-5.18C1.78-5.18 1.86-5.05 1.86-4.77V-.81C1.86-.52 1.79-.32 1.65-.24C1.52-.17 1.4-.14 1.03-.13V0H3.44Z'/>
<path id='eq263-g5-50' d='M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z'/>
<path id='eq263-g1-95' d='M6.28-.87L6.26-.89C6.1-.89 5.9-.49 5.4-.49C3.14-.49 7.24-7.8 3.74-7.8H3.61C3.39-7.8 2.89-7.62 2.74-7.48C2.73-7.47 2.82-7.36 2.83-7.36C2.89-7.41 3.16-7.52 3.39-7.52C4.55-7.52 4.24-5.61 4.24-5.3C4.25-5.26 4.24-5.24 4.23-5.19C3.99-4.09 .48-.96 .19 0H1.38C1.38-.12 1.39-.24 1.42-.37C1.76-1.89 4.1-4.2 4.1-4.22H4.11C4.04-3.6 2.97 .13 4.91 .13C5.43 .13 6.25-.73 6.28-.87Z'/>
<path id='eq263-g1-161' d='M6.84-2.94V-3.18L.74-6.05V-5.38L5.69-3.06L.74-.74V-.07L6.84-2.94Z'/>
</defs>
<g id='eq263-page1'>
<use x='-.16' y='0' xlink:href='#eq263-g1-95'/>
<use x='6.54' y='1.79' xlink:href='#eq263-g5-49'/>
<use x='14.99' y='0' xlink:href='#eq263-g1-161'/>
<use x='26.02' y='0' xlink:href='#eq263-g1-95'/>
<use x='32.72' y='1.79' xlink:href='#eq263-g5-50'/>
</g>
</svg></span>,
then it is possible to define a measure of anisotropy as
<span class="m-math"><svg style="width: 2.285em; height: 1.661em; vertical-align: -0.549em;" viewBox="1.08 -11.14 22.85 16.61">
<title>
\(\frac{\lambda_1 - \lambda_2}{\lambda_1 + \lambda_2}\)
</title>
<defs>
<path id='eq264-g8-49' d='M2.58 0V-.1C2.06-.1 1.96-.17 1.96-.48V-4.42L1.91-4.43L.73-3.83V-3.74C.81-3.77 .88-3.8 .9-3.81C1.02-3.86 1.13-3.88 1.2-3.88C1.34-3.88 1.4-3.79 1.4-3.58V-.61C1.4-.39 1.34-.24 1.24-.18C1.14-.12 1.05-.1 .77-.1V0H2.58Z'/>
<path id='eq264-g8-50' d='M3.11-.9L3.03-.93C2.78-.56 2.7-.5 2.4-.5H.84L1.94-1.65C2.52-2.26 2.78-2.76 2.78-3.27C2.78-3.92 2.25-4.43 1.57-4.43C1.21-4.43 .86-4.28 .62-4.02C.41-3.8 .31-3.59 .2-3.12L.34-3.09C.6-3.73 .84-3.94 1.29-3.94C1.84-3.94 2.21-3.57 2.21-3.02C2.21-2.51 1.91-1.9 1.36-1.32L.2-.08V0H2.75L3.11-.9Z'/>
<path id='eq264-g1-0' d='M5.01-2V-2.49H.54V-2H5.01Z'/>
<path id='eq264-g1-184' d='M2.17-2.5H.26V-1.92H2.17V0H2.75V-1.92H4.66V-2.5H2.75V-4.42H2.17V-2.5Z'/>
<path id='eq264-g4-95' d='M4.6-.64L4.59-.66C4.47-.66 4.32-.36 3.96-.36C2.31-.36 5.31-5.72 2.74-5.72H2.65C2.49-5.72 2.12-5.59 2.01-5.49C2-5.48 2.07-5.4 2.08-5.4C2.12-5.43 2.31-5.51 2.49-5.51C3.34-5.51 3.11-4.11 3.11-3.89C3.12-3.86 3.11-3.84 3.1-3.81C2.93-3 .35-.71 .14 0H1.01C1.01-.09 1.02-.17 1.04-.27C1.29-1.39 3-3.08 3-3.09H3.01C2.96-2.64 2.17 .1 3.6 .1C3.98 .1 4.59-.53 4.6-.64Z'/>
</defs>
<g id='eq264-page1'>
<use x='1.08' y='-5.42' xlink:href='#eq264-g4-95'/>
<use x='5.99' y='-4.08' xlink:href='#eq264-g8-49'/>
<use x='9.78' y='-5.42' xlink:href='#eq264-g1-0'/>
<use x='15.24' y='-5.42' xlink:href='#eq264-g4-95'/>
<use x='20.15' y='-4.08' xlink:href='#eq264-g8-50'/>
<rect x='1.2' y='-3.41' height='.67' width='22.74'/>
<use x='1.4' y='4.12' xlink:href='#eq264-g4-95'/>
<use x='6.31' y='5.47' xlink:href='#eq264-g8-49'/>
<use x='10.09' y='4.12' xlink:href='#eq264-g1-184'/>
<use x='14.92' y='4.12' xlink:href='#eq264-g4-95'/>
<use x='19.83' y='5.47' xlink:href='#eq264-g8-50'/>
</g>
</svg></span>
or simply as <span class="m-math"><svg style="width: 2.867em; height: 1.661em; vertical-align: -0.549em;" viewBox="0 -11.14 28.67 16.61">
<title>
\(1 - \frac{\lambda_2}{\lambda_1}\)
</title>
<defs>
<path id='eq265-g4-95' d='M4.6-.64L4.59-.66C4.47-.66 4.32-.36 3.96-.36C2.31-.36 5.31-5.72 2.74-5.72H2.65C2.49-5.72 2.12-5.59 2.01-5.49C2-5.48 2.07-5.4 2.08-5.4C2.12-5.43 2.31-5.51 2.49-5.51C3.34-5.51 3.11-4.11 3.11-3.89C3.12-3.86 3.11-3.84 3.1-3.81C2.93-3 .35-.71 .14 0H1.01C1.01-.09 1.02-.17 1.04-.27C1.29-1.39 3-3.08 3-3.09H3.01C2.96-2.64 2.17 .1 3.6 .1C3.98 .1 4.59-.53 4.6-.64Z'/>
<path id='eq265-g8-49' d='M2.58 0V-.1C2.06-.1 1.96-.17 1.96-.48V-4.42L1.91-4.43L.73-3.83V-3.74C.81-3.77 .88-3.8 .9-3.81C1.02-3.86 1.13-3.88 1.2-3.88C1.34-3.88 1.4-3.79 1.4-3.58V-.61C1.4-.39 1.34-.24 1.24-.18C1.14-.12 1.05-.1 .77-.1V0H2.58Z'/>
<path id='eq265-g8-50' d='M3.11-.9L3.03-.93C2.78-.56 2.7-.5 2.4-.5H.84L1.94-1.65C2.52-2.26 2.78-2.76 2.78-3.27C2.78-3.92 2.25-4.43 1.57-4.43C1.21-4.43 .86-4.28 .62-4.02C.41-3.8 .31-3.59 .2-3.12L.34-3.09C.6-3.73 .84-3.94 1.29-3.94C1.84-3.94 2.21-3.57 2.21-3.02C2.21-2.51 1.91-1.9 1.36-1.32L.2-.08V0H2.75L3.11-.9Z'/>
<path id='eq265-g1-0' d='M6.84-2.73V-3.39H.74V-2.73H6.84Z'/>
<use id='eq265-g11-49' xlink:href='#eq265-g8-49' transform='scale(1.82)'/>
</defs>
<g id='eq265-page1'>
<use x='0' y='0' xlink:href='#eq265-g11-49'/>
<use x='8.63' y='0' xlink:href='#eq265-g1-0'/>
<use x='19.98' y='-5.42' xlink:href='#eq265-g4-95'/>
<use x='24.89' y='-4.08' xlink:href='#eq265-g8-50'/>
<rect x='20.09' y='-3.41' height='.67' width='8.58'/>
<use x='19.98' y='4.12' xlink:href='#eq265-g4-95'/>
<use x='24.89' y='5.47' xlink:href='#eq265-g8-49'/>
</g>
</svg></span>, and an energy
measure as <span class="m-math"><svg style="width: 3.432em; height: 0.959em; vertical-align: -0.180em;" viewBox="-.16 -7.8 34.32 9.59">
<title>
\(\lambda_1 + \lambda_2\)
</title>
<defs>
<path id='eq266-g1-184' d='M2.97-3.41H.36V-2.62H2.97V0H3.75V-2.62H6.36V-3.41H3.75V-6.03H2.97V-3.41Z'/>
<path id='eq266-g8-49' d='M3.44 0V-.13C2.75-.14 2.61-.23 2.61-.65V-5.89L2.54-5.9L.97-5.11V-4.99C1.07-5.03 1.17-5.07 1.21-5.08C1.36-5.14 1.51-5.18 1.6-5.18C1.78-5.18 1.86-5.05 1.86-4.77V-.81C1.86-.52 1.79-.32 1.65-.24C1.52-.17 1.4-.14 1.03-.13V0H3.44Z'/>
<path id='eq266-g8-50' d='M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z'/>
<path id='eq266-g4-95' d='M6.28-.87L6.26-.89C6.1-.89 5.9-.49 5.4-.49C3.14-.49 7.24-7.8 3.74-7.8H3.61C3.39-7.8 2.89-7.62 2.74-7.48C2.73-7.47 2.82-7.36 2.83-7.36C2.89-7.41 3.16-7.52 3.39-7.52C4.55-7.52 4.24-5.61 4.24-5.3C4.25-5.26 4.24-5.24 4.23-5.19C3.99-4.09 .48-.96 .19 0H1.38C1.38-.12 1.39-.24 1.42-.37C1.76-1.89 4.1-4.2 4.1-4.22H4.11C4.04-3.6 2.97 .13 4.91 .13C5.43 .13 6.25-.73 6.28-.87Z'/>
</defs>
<g id='eq266-page1'>
<use x='-.16' y='0' xlink:href='#eq266-g4-95'/>
<use x='6.54' y='1.79' xlink:href='#eq266-g8-49'/>
<use x='14.08' y='0' xlink:href='#eq266-g1-184'/>
<use x='23.32' y='0' xlink:href='#eq266-g4-95'/>
<use x='30.02' y='1.79' xlink:href='#eq266-g8-50'/>
</g>
</svg></span>. Anisotropy is high on lines and edges,
and small on uniform areas. Furthermore, the direction of the eigenvector
corresponding to the largest eigenvalue gives the orientation perpendicular to
the line or edge.</p>
<p>The anisotropy measure generalizes to higher-dimensional images. For example,
in a 3D image it is possible to distinguish lines (two large eigenvalues),
planes (one large eigenvalue), and isotropic areas (all eigenvalues approximately
equal).</p>
<p>To compute the structure tensor using <em>DIPlib</em>, we start with a scalar image <code>img</code>:</p>
<div class="m-code"><pre><span></span><span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">g</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Gradient</span><span class="p">(</span> <span class="n">img</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">S</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Gauss</span><span class="p">(</span> <span class="n">g</span> <span class="o">*</span> <span class="n">dip</span><span class="o">::</span><span class="n">Transpose</span><span class="p">(</span> <span class="n">g</span> <span class="p">),</span> <span class="mi">5</span> <span class="p">);</span>
</pre></div>

<p>The image <code>S</code> is a 2-by-2 tensor image if <code>img</code> is a 2D image, or a 5-by-5 tensor
image if <code>img</code> is a 5D image. Note that, since <code>g * Transpose(g)</code> yields a
symmetric matrix, <code>S</code> is stored in such a way that no duplicate matrix elements
are stored (nor computed). That is, for the 2D case, <code>S</code> has 3 tensor elements,
corresponding to the two diagonal elements and the one unique off-diagonal element.
The constant 5 in the computation of <code>S</code> is the sigma of the Gaussian smoothing.
This value needs to be adjusted depending on the scale of the structures we are
interested in.</p>
<div class="m-code"><pre><span></span><span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">e</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Eigenvalues</span><span class="p">(</span> <span class="n">S</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">anisoptropy</span> <span class="o">=</span> <span class="p">(</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>
</pre></div>

<p>Note that it is possible to compute the <code>anisotropy</code> image more efficiently
(running through the image <code>e</code> once instead of three times, and avoiding
the storage of two intermediate images). See <a href="iterators.html">Iterators</a>.</p>
<p>The above is implemented in the functions <a href="analysis.html#dip-StructureTensor-dip-Image-CL-dip-Image-CL-dip-Image-L-dip-FloatArray-CL-dip-FloatArray-CL-dip-String-CL-dip-StringArray-CL-dip-dfloat-"><code>dip::StructureTensor</code></a> and
<a href="analysis.html#dip-StructureTensorAnalysis-dip-Image-CL-dip-ImageRefArray-L-dip-StringArray-CL"><code>dip::StructureTensorAnalysis</code></a>.</p>
<h2 id="harris">The Harris corner detector</h2>
<p>The well-known Harris corner detector (see
<a href="https://en.wikipedia.org/wiki/Corner_detection#The_Harris_.26_Stephens_.2F_Plessey_.2F_Shi.E2.80.93Tomasi_corner_detection_algorithms">Wikipedia</a>)
is based on the structure tensor. Pixels where the two eigenvalues are large
are corners. It is common to use the following equivalence to avoid computation
of the eigenvalues:</p>
<div class="m-math"><svg style="width: 19.687em; height: 1.325em;" viewBox="95.39 -13.19 196.87 13.25">
<title>
\[ \lambda_1 \lambda_2 - \kappa \, (\lambda_1 + \lambda_2)^2 = \mathrm{det}\,S - \kappa \, (\mathrm{trace}\,S)^2 \]
</title>
<defs>
<path id='eq246-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<path id='eq246-g4-0' d='M6.84-2.73V-3.39H.74V-2.73H6.84Z'/>
<path id='eq246-g4-184' d='M2.97-3.41H.36V-2.62H2.97V0H3.75V-2.62H6.36V-3.41H3.75V-6.03H2.97V-3.41Z'/>
<path id='eq246-g4-185' d='M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z'/>
<path id='eq246-g4-186' d='M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z'/>
<use id='eq246-g14-97' xlink:href='#eq246-g11-97' transform='scale(1.36)'/>
<use id='eq246-g14-99' xlink:href='#eq246-g11-99' transform='scale(1.36)'/>
<use id='eq246-g14-100' xlink:href='#eq246-g11-100' transform='scale(1.36)'/>
<use id='eq246-g14-101' xlink:href='#eq246-g11-101' transform='scale(1.36)'/>
<use id='eq246-g14-114' xlink:href='#eq246-g11-114' transform='scale(1.36)'/>
<use id='eq246-g14-116' xlink:href='#eq246-g11-116' transform='scale(1.36)'/>
<path id='eq246-g11-49' d='M3.44 0V-.13C2.75-.14 2.61-.23 2.61-.65V-5.89L2.54-5.9L.97-5.11V-4.99C1.07-5.03 1.17-5.07 1.21-5.08C1.36-5.14 1.51-5.18 1.6-5.18C1.78-5.18 1.86-5.05 1.86-4.77V-.81C1.86-.52 1.79-.32 1.65-.24C1.52-.17 1.4-.14 1.03-.13V0H3.44Z'/>
<path id='eq246-g11-50' d='M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z'/>
<path id='eq246-g11-97' d='M3.86-.35V-.58C3.71-.45 3.61-.41 3.48-.41C3.28-.41 3.21-.53 3.21-.92V-2.62C3.21-3.07 3.17-3.31 3.05-3.51C2.86-3.84 2.49-4.02 1.96-4.02C1.51-4.02 1.09-3.9 .85-3.69C.63-3.51 .49-3.26 .49-3.04C.49-2.84 .66-2.66 .86-2.66S1.26-2.84 1.26-3.03C1.26-3.07 1.25-3.11 1.24-3.17C1.22-3.25 1.21-3.32 1.21-3.38C1.21-3.62 1.49-3.81 1.84-3.81C2.27-3.81 2.51-3.55 2.51-3.08V-2.55C1.16-2.01 1.01-1.94 .64-1.61C.45-1.43 .32-1.14 .32-.85C.32-.3 .7 .09 1.24 .09C1.62 .09 1.98-.1 2.52-.55C2.56-.09 2.72 .09 3.07 .09C3.37 .09 3.55-.02 3.86-.35ZM2.51-1.07C2.51-.8 2.46-.72 2.28-.61C2.07-.49 1.83-.42 1.64-.42C1.34-.42 1.09-.72 1.09-1.09V-1.13C1.09-1.64 1.45-1.96 2.51-2.34V-1.07Z'/>
<path id='eq246-g11-99' d='M3.6-1.28L3.48-1.36C3.06-.75 2.74-.54 2.24-.54C1.44-.54 .89-1.24 .89-2.24C.89-3.15 1.37-3.76 2.08-3.76C2.39-3.76 2.51-3.67 2.59-3.35L2.65-3.15C2.72-2.9 2.87-2.75 3.07-2.75C3.29-2.75 3.48-2.92 3.48-3.12C3.48-3.61 2.86-4.02 2.13-4.02C1.72-4.02 1.3-3.86 .95-3.57C.48-3.18 .22-2.58 .22-1.85C.22-.72 .91 .09 1.88 .09C2.25 .09 2.59-.03 2.88-.28C3.14-.49 3.32-.74 3.6-1.28Z'/>
<path id='eq246-g11-100' d='M4.29-.37V-.51C4.13-.5 4.11-.5 4.09-.5C3.77-.5 3.7-.59 3.7-1V-5.95L3.66-5.97C3.24-5.82 2.93-5.73 2.38-5.58V-5.44C2.45-5.45 2.5-5.45 2.57-5.45C2.89-5.45 2.97-5.36 2.97-5V-3.64C2.64-3.92 2.4-4.02 2.05-4.02C1.05-4.02 .24-3.03 .24-1.79C.24-.67 .89 .09 1.85 .09C2.34 .09 2.67-.09 2.97-.5V.06L3 .09L4.29-.37ZM2.97-.89C2.97-.83 2.91-.72 2.82-.63C2.66-.45 2.45-.37 2.19-.37C1.47-.37 .99-1.07 .99-2.14C.99-3.13 1.41-3.77 2.08-3.77C2.54-3.77 2.97-3.36 2.97-2.9V-.89Z'/>
<path id='eq246-g11-101' d='M3.7-1.37L3.56-1.43C3.14-.77 2.77-.52 2.21-.52C1.73-.52 1.36-.74 1.11-1.21C.93-1.55 .86-1.86 .85-2.42H3.54C3.47-2.99 3.38-3.24 3.16-3.52C2.9-3.83 2.5-4.02 2.04-4.02C.96-4.02 .22-3.14 .22-1.87C.22-.66 .85 .09 1.85 .09C2.69 .09 3.34-.43 3.7-1.37ZM2.65-2.7H.86C.96-3.39 1.26-3.7 1.79-3.7S2.53-3.46 2.65-2.7Z'/>
<path id='eq246-g11-114' d='M2.93-3.55C2.93-3.84 2.74-4.02 2.45-4.02C2.08-4.02 1.83-3.82 1.4-3.2V-4L1.35-4.02C.89-3.83 .58-3.71 .06-3.55V-3.41C.18-3.43 .26-3.44 .37-3.44C.59-3.44 .66-3.3 .66-2.92V-.73C.66-.3 .6-.24 .04-.13V0H2.14V-.13C1.55-.16 1.4-.29 1.4-.79V-2.75C1.4-3.03 1.77-3.47 2.01-3.47C2.06-3.47 2.14-3.42 2.24-3.34C2.38-3.21 2.47-3.16 2.59-3.16C2.79-3.16 2.93-3.31 2.93-3.55Z'/>
<path id='eq246-g11-116' d='M2.44-.58L2.32-.67C2.13-.45 1.99-.37 1.8-.37C1.48-.37 1.35-.59 1.35-1.15V-3.65H2.23V-3.93H1.35V-4.94C1.35-5.03 1.33-5.06 1.28-5.06C1.23-4.97 1.17-4.89 1.11-4.81C.79-4.33 .49-4.01 .26-3.88C.17-3.82 .11-3.76 .11-3.71C.11-3.69 .12-3.67 .15-3.65H.61V-1.02C.61-.29 .87 .09 1.38 .09C1.82 .09 2.15-.12 2.44-.58Z'/>
<path id='eq246-g7-40' d='M5.13-2.17C5.13-2.94 4.87-3.39 3.79-4.49C2.7-5.57 2.61-5.74 2.61-6.32C2.61-7.07 3.11-7.54 3.92-7.54C4.36-7.54 4.72-7.4 4.97-7.11C5.24-6.81 5.34-6.41 5.36-5.61L5.57-5.57L6.05-7.94H5.78C5.61-7.69 5.5-7.63 5.24-7.63C5.09-7.63 4.94-7.67 4.69-7.77C4.44-7.87 4.05-7.93 3.68-7.93C2.44-7.93 1.56-7.11 1.56-5.94C1.56-5.3 1.74-4.95 2.45-4.19C2.61-4.04 2.76-3.87 2.92-3.69L3.38-3.19C3.94-2.61 4.1-2.3 4.1-1.79C4.1-.88 3.44-.2 2.56-.2C1.56-.2 .82-1.05 .82-2.22C.82-2.3 .82-2.35 .85-2.45L.61-2.48L.2 .18H.42C.5-.1 .63-.21 .87-.21C1-.21 1.17-.17 1.49-.06C2.04 .14 2.36 .21 2.73 .21C4.1 .21 5.13-.81 5.13-2.17Z'/>
<path id='eq246-g7-94' d='M5.32-4.91C5.32-5.07 5.26-5.23 5.03-5.23C4.11-5.23 3.39-3.11 1.92-2.7L2.58-5.25L1.6-5.09L.48-.96C.38-.61 .15-.14 .08 0H1.17L1.77-2.17C1.79-2.17 1.81-2.17 1.98-2.25L3.04-.37C3.26 .02 3.62 .13 3.95 .13C4.26 .13 4.55 .01 4.6 .01L4.67-.2C4.25-.2 4.14-.23 3.98-.54L2.82-2.69C3.45-3.1 4.19-4.29 4.55-4.29C4.88-4.29 5.32-4.51 5.32-4.91Z'/>
<path id='eq246-g7-95' d='M6.28-.87L6.26-.89C6.1-.89 5.9-.49 5.4-.49C3.14-.49 7.24-7.8 3.74-7.8H3.61C3.39-7.8 2.89-7.62 2.74-7.48C2.73-7.47 2.82-7.36 2.83-7.36C2.89-7.41 3.16-7.52 3.39-7.52C4.55-7.52 4.24-5.61 4.24-5.3C4.25-5.26 4.24-5.24 4.23-5.19C3.99-4.09 .48-.96 .19 0H1.38C1.38-.12 1.39-.24 1.42-.37C1.76-1.89 4.1-4.2 4.1-4.22H4.11C4.04-3.6 2.97 .13 4.91 .13C5.43 .13 6.25-.73 6.28-.87Z'/>
</defs>
<g id='eq246-page1'>
<use x='95.39' y='-2.35' xlink:href='#eq246-g7-95'/>
<use x='102.09' y='-.56' xlink:href='#eq246-g11-49'/>
<use x='106.81' y='-2.35' xlink:href='#eq246-g7-95'/>
<use x='113.51' y='-.56' xlink:href='#eq246-g11-50'/>
<use x='121.05' y='-2.35' xlink:href='#eq246-g4-0'/>
<use x='131.63' y='-2.35' xlink:href='#eq246-g7-94'/>
<use x='139.92' y='-2.35' xlink:href='#eq246-g4-185'/>
<use x='144.23' y='-2.35' xlink:href='#eq246-g7-95'/>
<use x='150.92' y='-.56' xlink:href='#eq246-g11-49'/>
<use x='158.46' y='-2.35' xlink:href='#eq246-g4-184'/>
<use x='167.7' y='-2.35' xlink:href='#eq246-g7-95'/>
<use x='174.4' y='-.56' xlink:href='#eq246-g11-50'/>
<use x='179.28' y='-2.35' xlink:href='#eq246-g4-186'/>
<use x='183.86' y='-7.29' xlink:href='#eq246-g11-50'/>
<use x='192.06' y='-2.35' xlink:href='#eq246-g1-61'/>
<use x='202.46' y='-2.35' xlink:href='#eq246-g14-100'/>
<use x='208.44' y='-2.35' xlink:href='#eq246-g14-101'/>
<use x='213.75' y='-2.35' xlink:href='#eq246-g14-116'/>
<use x='219.31' y='-2.35' xlink:href='#eq246-g7-40'/>
<use x='228.35' y='-2.35' xlink:href='#eq246-g4-0'/>
<use x='238.94' y='-2.35' xlink:href='#eq246-g7-94'/>
<use x='247.23' y='-2.35' xlink:href='#eq246-g4-185'/>
<use x='251.69' y='-2.35' xlink:href='#eq246-g14-116'/>
<use x='255.01' y='-2.35' xlink:href='#eq246-g14-114'/>
<use x='258.99' y='-2.35' xlink:href='#eq246-g14-97'/>
<use x='264.3' y='-2.35' xlink:href='#eq246-g14-99'/>
<use x='269.61' y='-2.35' xlink:href='#eq246-g14-101'/>
<use x='277.15' y='-2.35' xlink:href='#eq246-g7-40'/>
<use x='283.53' y='-2.35' xlink:href='#eq246-g4-186'/>
<use x='288.11' y='-7.29' xlink:href='#eq246-g11-50'/>
</g>
</svg></div>
<p>We can compute this in <em>DIPlib</em> as follows, again starting with a scalar
image <code>img</code>:</p>
<div class="m-code"><pre><span></span><span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">g</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Gradient</span><span class="p">(</span> <span class="n">img</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">S</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Gauss</span><span class="p">(</span> <span class="n">g</span> <span class="o">*</span> <span class="n">dip</span><span class="o">::</span><span class="n">Transpose</span><span class="p">(</span> <span class="n">g</span> <span class="p">),</span> <span class="mi">5</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Trace</span><span class="p">(</span> <span class="n">S</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">corners</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Determinant</span><span class="p">(</span> <span class="n">S</span> <span class="p">)</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="n">trace</span> <span class="o">*</span> <span class="n">trace</span><span class="p">;</span>
</pre></div>

<p>Note again that is is possible to compute <code>corners</code> more efficiently
by <a href="iterators.html">Iterators</a>. That way, one can run through the image <code>S</code> only once,
and avoid the temporary intermediate images.</p>
<p>The above is implemented in the function <a href="detection_corners.html#dip-HarrisCornerDetector-dip-Image-CL-dip-Image-L-dip-dfloat--dip-FloatArray-CL-dip-StringArray-CL"><code>dip::HarrisCornerDetector</code></a>.</p>
<h2 id="optical_flow">Lucas-Kanade optical flow</h2>
<p>The Lucas-Kanade solution to the optical flow problem (see
<a href="https://en.wikipedia.org/wiki/Lucasâ€“Kanade_method">Wikipedia</a>)
also involves the structure tensor. The problem to solve is <span class="m-math"><svg style="width: 3.365em; height: 0.835em; vertical-align: -0.022em;" viewBox=".29 -8.13 33.65 8.35">
<title>
\(Av=b\)
</title>
<defs>
<path id='eq267-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<path id='eq267-g4-22' d='M6.72 0V-.19C6.04-.25 5.96-.35 5.81-1.21L4.69-7.96H4.38L.93-2C-.01-.42-.13-.29-.61-.19V0H1.62V-.19C1.01-.25 .92-.31 .92-.61C.92-.83 .95-.94 1.16-1.35L1.83-2.69H4.45L4.69-1.13C4.7-1.02 4.72-.92 4.72-.82C4.72-.37 4.55-.26 3.79-.19V0H6.72ZM4.39-3.12H2.08L3.87-6.22L4.39-3.12Z'/>
<path id='eq267-g4-49' d='M5.63-3.82C5.63-4.66 5.05-5.25 4.25-5.25C3.42-5.25 2.8-4.76 1.95-3.45L3.19-8.08L3.13-8.13C2.54-8.03 2.11-7.96 1.31-7.86V-7.66C2.01-7.63 2.08-7.6 2.08-7.34C2.08-7.23 2.06-7.1 1.98-6.82L1.92-6.6L1.89-6.52L.27-.55V-.5C.27-.23 1.18 .13 1.86 .13C3.66 .13 5.63-1.94 5.63-3.82ZM4.62-3.64C4.62-2.86 4.03-1.58 3.31-.85C2.87-.39 2.36-.14 1.85-.14C1.48-.14 1.3-.27 1.3-.55C1.3-1.26 1.66-2.41 2.16-3.3C2.68-4.22 3.22-4.67 3.79-4.67C4.31-4.67 4.62-4.28 4.62-3.64Z'/>
<path id='eq267-g4-69' d='M5.07-4.55C5.07-4.93 4.76-5.25 4.41-5.25C4.13-5.25 3.97-5.1 3.97-4.85C3.97-4.66 4.04-4.51 4.25-4.32C4.41-4.18 4.47-4.09 4.47-3.97C4.47-3.41 3.69-2.1 2.83-1.21L2.47-.83C2.38-2.44 2.32-3.11 2.17-3.89C1.94-5.18 1.92-5.25 1.81-5.25C1.75-5.25 1.67-5.24 1.57-5.2C1.19-5.12 .79-5.04 .25-4.95V-4.8C.38-4.81 .49-4.81 .61-4.81C1.05-4.81 1.19-4.6 1.33-3.7C1.48-2.8 1.62-1.06 1.62-.33C1.62-.11 1.62 .21 1.73 .21C2.02 .21 3.1-1 4.35-2.74C4.76-3.33 5.07-4.1 5.07-4.55Z'/>
</defs>
<g id='eq267-page1'>
<use x='.9' y='0' xlink:href='#eq267-g4-22'/>
<use x='8.45' y='0' xlink:href='#eq267-g4-69'/>
<use x='17.62' y='0' xlink:href='#eq267-g1-61'/>
<use x='28.3' y='0' xlink:href='#eq267-g4-49'/>
</g>
</svg></span>,
where <span class="m-math"><svg style="width: 0.732em; height: 0.796em; vertical-align: -0.000em;" viewBox=".29 -7.96 7.32 7.96">
<title>
\(A\)
</title>
<defs>
<path id='eq268-g1-22' d='M6.72 0V-.19C6.04-.25 5.96-.35 5.81-1.21L4.69-7.96H4.38L.93-2C-.01-.42-.13-.29-.61-.19V0H1.62V-.19C1.01-.25 .92-.31 .92-.61C.92-.83 .95-.94 1.16-1.35L1.83-2.69H4.45L4.69-1.13C4.7-1.02 4.72-.92 4.72-.82C4.72-.37 4.55-.26 3.79-.19V0H6.72ZM4.39-3.12H2.08L3.87-6.22L4.39-3.12Z'/>
</defs>
<g id='eq268-page1'>
<use x='.9' y='0' xlink:href='#eq268-g1-22'/>
</g>
</svg></span> is a matrix with <span class="m-math"><svg style="width: 0.565em; height: 0.538em; vertical-align: -0.013em;" viewBox="-.32 -5.25 5.65 5.38">
<title>
\(x\)
</title>
<defs>
<path id='eq269-g1-71' d='M4.95-1.23L4.79-1.32C4.69-1.2 4.63-1.14 4.53-1C4.25-.64 4.12-.52 3.97-.52C3.8-.52 3.69-.68 3.61-1.01C3.59-1.12 3.57-1.18 3.56-1.2C3.28-2.32 3.13-2.97 3.13-3.14C3.66-4.06 4.09-4.59 4.3-4.59C4.37-4.59 4.48-4.55 4.59-4.49C4.73-4.41 4.81-4.38 4.92-4.38C5.16-4.38 5.32-4.56 5.32-4.81C5.32-5.07 5.12-5.25 4.84-5.25C4.31-5.25 3.87-4.82 3.04-3.55L2.91-4.2C2.74-5.01 2.61-5.25 2.29-5.25C2.01-5.25 1.63-5.16 .89-4.91L.76-4.86L.81-4.68L1.01-4.73C1.24-4.79 1.38-4.81 1.48-4.81C1.77-4.81 1.85-4.7 2.01-3.99L2.36-2.53L1.38-1.13C1.13-.77 .91-.56 .77-.56C.7-.56 .58-.6 .46-.67C.31-.75 .19-.79 .08-.79C-.15-.79-.32-.61-.32-.37C-.32-.06-.1 .13 .27 .13S.79 .02 1.38-.69L2.45-2.1L2.81-.67C2.97-.05 3.12 .13 3.5 .13C3.95 .13 4.26-.15 4.95-1.23Z'/>
</defs>
<g id='eq269-page1'>
<use x='0' y='0' xlink:href='#eq269-g1-71'/>
</g>
</svg></span> and <span class="m-math"><svg style="width: 0.536em; height: 0.771em; vertical-align: -0.246em;" viewBox=".19 -5.25 5.36 7.71">
<title>
\(y\)
</title>
<defs>
<path id='eq270-g1-72' d='M5.07-4.6C5.07-4.95 4.78-5.25 4.42-5.25C4.14-5.25 3.95-5.07 3.95-4.81C3.95-4.62 4.05-4.5 4.29-4.35C4.51-4.22 4.6-4.11 4.6-3.94C4.6-3.47 4.17-2.55 3.14-.86L2.91-2.24C2.73-3.3 2.06-5.25 1.88-5.25H1.83L1.73-5.24L.56-5.04L.18-4.97V-4.76C.32-4.8 .42-4.81 .55-4.81C1.02-4.81 1.24-4.63 1.46-4.05C1.79-3.24 2.44-.57 2.44-.1C2.44 .04 2.39 .18 2.32 .32C2.23 .48 1.69 1.18 1.48 1.41C1.2 1.7 1.06 1.8 .91 1.8C.82 1.8 .75 1.76 .62 1.67C.44 1.52 .32 1.46 .18 1.46C-.08 1.46-.29 1.67-.29 1.93C-.29 2.24-.04 2.45 .32 2.45C1 2.45 2.29 1.08 3.51-.96C4.51-2.61 5.07-3.92 5.07-4.6Z'/>
</defs>
<g id='eq270-page1'>
<use x='.48' y='0' xlink:href='#eq270-g1-72'/>
</g>
</svg></span> partial derivatives at each
pixel in a neighborhood, <span class="m-math"><svg style="width: 0.563em; height: 0.827em; vertical-align: -0.013em;" viewBox=".29 -8.13 5.63 8.27">
<title>
\(b\)
</title>
<defs>
<path id='eq271-g1-49' d='M5.63-3.82C5.63-4.66 5.05-5.25 4.25-5.25C3.42-5.25 2.8-4.76 1.95-3.45L3.19-8.08L3.13-8.13C2.54-8.03 2.11-7.96 1.31-7.86V-7.66C2.01-7.63 2.08-7.6 2.08-7.34C2.08-7.23 2.06-7.1 1.98-6.82L1.92-6.6L1.89-6.52L.27-.55V-.5C.27-.23 1.18 .13 1.86 .13C3.66 .13 5.63-1.94 5.63-3.82ZM4.62-3.64C4.62-2.86 4.03-1.58 3.31-.85C2.87-.39 2.36-.14 1.85-.14C1.48-.14 1.3-.27 1.3-.55C1.3-1.26 1.66-2.41 2.16-3.3C2.68-4.22 3.22-4.67 3.79-4.67C4.31-4.67 4.62-4.28 4.62-3.64Z'/>
</defs>
<g id='eq271-page1'>
<use x='.29' y='0' xlink:href='#eq271-g1-49'/>
</g>
</svg></span> is a vector with <span class="m-math"><svg style="width: 0.353em; height: 0.663em; vertical-align: -0.013em;" viewBox="-.05 -6.5 3.53 6.63">
<title>
\(t\)
</title>
<defs>
<path id='eq272-g1-67' d='M3.53-5.1H2.57L2.91-6.32C2.92-6.35 2.92-6.37 2.92-6.38C2.92-6.47 2.88-6.5 2.82-6.5C2.75-6.5 2.72-6.49 2.64-6.4C1.51-4.92 .68-5.17 .68-4.79C.68-4.78 .68-4.75 .69-4.72H1.57L.71-1.44C.68-1.29 .44-.55 .44-.32C.44-.06 .69 .13 1.01 .13C1.56 .13 1.95-.2 2.7-1.31L2.55-1.39C1.97-.64 1.77-.45 1.58-.45C1.48-.45 1.41-.55 1.41-.69C1.41-.7 1.41-.71 1.42-.75L2.47-4.72H3.47L3.53-5.1Z'/>
</defs>
<g id='eq272-page1'>
<use x='-.05' y='0' xlink:href='#eq272-g1-67'/>
</g>
</svg></span> derivatives at each
of those pixels, and <span class="m-math"><svg style="width: 0.507em; height: 0.547em; vertical-align: -0.022em;" viewBox=".1 -5.25 5.07 5.47">
<title>
\(v\)
</title>
<defs>
<path id='eq273-g1-69' d='M5.07-4.55C5.07-4.93 4.76-5.25 4.41-5.25C4.13-5.25 3.97-5.1 3.97-4.85C3.97-4.66 4.04-4.51 4.25-4.32C4.41-4.18 4.47-4.09 4.47-3.97C4.47-3.41 3.69-2.1 2.83-1.21L2.47-.83C2.38-2.44 2.32-3.11 2.17-3.89C1.94-5.18 1.92-5.25 1.81-5.25C1.75-5.25 1.67-5.24 1.57-5.2C1.19-5.12 .79-5.04 .25-4.95V-4.8C.38-4.81 .49-4.81 .61-4.81C1.05-4.81 1.19-4.6 1.33-3.7C1.48-2.8 1.62-1.06 1.62-.33C1.62-.11 1.62 .21 1.73 .21C2.02 .21 3.1-1 4.35-2.74C4.76-3.33 5.07-4.1 5.07-4.55Z'/>
</defs>
<g id='eq273-page1'>
<use x='.1' y='0' xlink:href='#eq273-g1-69'/>
</g>
</svg></span> is the velocity vector for the neighborhood.
This is rewritten as <span class="m-math"><svg style="width: 6.218em; height: 1.026em; vertical-align: -0.022em;" viewBox=".29 -10.04 62.18 10.26">
<title>
\(A^T A v = A^T b\)
</title>
<defs>
<path id='eq274-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<path id='eq274-g4-22' d='M4.93 0V-.14C4.43-.18 4.37-.25 4.26-.89L3.44-5.83H3.21L.68-1.47C-.01-.31-.1-.21-.45-.14V0H1.19V-.14C.74-.18 .67-.23 .67-.45C.67-.61 .7-.69 .85-.99L1.35-1.97H3.27L3.44-.83C3.45-.75 3.46-.67 3.46-.6C3.46-.27 3.34-.19 2.78-.14V0H4.93ZM3.22-2.29H1.53L2.84-4.56L3.22-2.29Z'/>
<path id='eq274-g4-41' d='M5.53-5.7H.88L.52-4.36L.67-4.32C1.11-5.22 1.39-5.4 2.57-5.4C2.63-5.4 2.69-5.4 2.75-5.4L1.49-.79C1.35-.32 1.14-.18 .57-.14V0H3.1V-.14L2.77-.17C2.41-.19 2.31-.27 2.31-.54C2.31-.65 2.33-.73 2.42-1.05L3.63-5.4H4.11C4.74-5.4 5.02-5.18 5.02-4.69C5.02-4.58 5.01-4.45 5-4.3L5.14-4.28L5.53-5.7Z'/>
<path id='eq274-g4-49' d='M4.13-2.8C4.13-3.42 3.7-3.85 3.12-3.85C2.51-3.85 2.05-3.49 1.43-2.53L2.34-5.92L2.3-5.97C1.86-5.89 1.55-5.83 .96-5.76V-5.62C1.48-5.6 1.53-5.57 1.53-5.38C1.53-5.3 1.51-5.21 1.45-5L1.41-4.84L1.39-4.78L.2-.4V-.37C.2-.17 .86 .1 1.36 .1C2.68 .1 4.13-1.42 4.13-2.8ZM3.39-2.67C3.39-2.1 2.95-1.16 2.43-.62C2.1-.29 1.73-.1 1.35-.1C1.08-.1 .95-.2 .95-.4C.95-.93 1.21-1.76 1.58-2.42C1.97-3.09 2.36-3.42 2.78-3.42C3.16-3.42 3.39-3.14 3.39-2.67Z'/>
<path id='eq274-g4-69' d='M3.72-3.34C3.72-3.62 3.49-3.85 3.23-3.85C3.03-3.85 2.91-3.74 2.91-3.55C2.91-3.42 2.96-3.31 3.12-3.17C3.23-3.07 3.28-3 3.28-2.91C3.28-2.5 2.71-1.54 2.08-.89L1.81-.61C1.75-1.79 1.7-2.28 1.59-2.86C1.42-3.8 1.41-3.85 1.33-3.85C1.28-3.85 1.22-3.84 1.15-3.82C.87-3.76 .58-3.69 .18-3.63V-3.52C.28-3.53 .36-3.53 .45-3.53C.77-3.53 .87-3.37 .98-2.72C1.08-2.05 1.19-.78 1.19-.24C1.19-.08 1.19 .16 1.27 .16C1.48 .16 2.27-.73 3.19-2.01C3.49-2.45 3.72-3 3.72-3.34Z'/>
<use id='eq274-g7-22' xlink:href='#eq274-g4-22' transform='scale(1.36)'/>
<use id='eq274-g7-49' xlink:href='#eq274-g4-49' transform='scale(1.36)'/>
<use id='eq274-g7-69' xlink:href='#eq274-g4-69' transform='scale(1.36)'/>
</defs>
<g id='eq274-page1'>
<use x='.9' y='0' xlink:href='#eq274-g7-22'/>
<use x='8.05' y='-4.34' xlink:href='#eq274-g4-41'/>
<use x='15.16' y='0' xlink:href='#eq274-g7-22'/>
<use x='22.72' y='0' xlink:href='#eq274-g7-69'/>
<use x='31.88' y='0' xlink:href='#eq274-g1-61'/>
<use x='43.18' y='0' xlink:href='#eq274-g7-22'/>
<use x='50.33' y='-4.34' xlink:href='#eq274-g4-41'/>
<use x='56.83' y='0' xlink:href='#eq274-g7-49'/>
</g>
</svg></span>, where <span class="m-math"><svg style="width: 2.159em; height: 1.004em; vertical-align: -0.000em;" viewBox=".29 -10.04 21.59 10.04">
<title>
\(A^T A\)
</title>
<defs>
<path id='eq275-g1-22' d='M4.93 0V-.14C4.43-.18 4.37-.25 4.26-.89L3.44-5.83H3.21L.68-1.47C-.01-.31-.1-.21-.45-.14V0H1.19V-.14C.74-.18 .67-.23 .67-.45C.67-.61 .7-.69 .85-.99L1.35-1.97H3.27L3.44-.83C3.45-.75 3.46-.67 3.46-.6C3.46-.27 3.34-.19 2.78-.14V0H4.93ZM3.22-2.29H1.53L2.84-4.56L3.22-2.29Z'/>
<path id='eq275-g1-41' d='M5.53-5.7H.88L.52-4.36L.67-4.32C1.11-5.22 1.39-5.4 2.57-5.4C2.63-5.4 2.69-5.4 2.75-5.4L1.49-.79C1.35-.32 1.14-.18 .57-.14V0H3.1V-.14L2.77-.17C2.41-.19 2.31-.27 2.31-.54C2.31-.65 2.33-.73 2.42-1.05L3.63-5.4H4.11C4.74-5.4 5.02-5.18 5.02-4.69C5.02-4.58 5.01-4.45 5-4.3L5.14-4.28L5.53-5.7Z'/>
<use id='eq275-g4-22' xlink:href='#eq275-g1-22' transform='scale(1.36)'/>
</defs>
<g id='eq275-page1'>
<use x='.9' y='0' xlink:href='#eq275-g4-22'/>
<use x='8.05' y='-4.34' xlink:href='#eq275-g1-41'/>
<use x='15.16' y='0' xlink:href='#eq275-g4-22'/>
</g>
</svg></span> is the
structure tensor. Using <em>DIPlib</em>, and assuming a 3D image <code>img</code> where
the third dimension is time, we can write:</p>
<div class="m-code"><pre><span></span><span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">A</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Gradient</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="p">{</span> <span class="mf">1.0</span> <span class="p">},</span> <span class="s">&quot;best&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span> <span class="p">}</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">dip</span><span class="o">::</span><span class="n">Derivative</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">ATA</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Gauss</span><span class="p">(</span> <span class="n">A</span> <span class="o">*</span> <span class="n">dip</span><span class="o">::</span><span class="n">Transpose</span><span class="p">(</span> <span class="n">A</span> <span class="p">),</span> <span class="mi">5</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">ATb</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Gauss</span><span class="p">(</span> <span class="n">A</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="mi">5</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">v</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Inverse</span><span class="p">(</span> <span class="n">ATA</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ATb</span><span class="p">;</span>
</pre></div>

<p>The most complicated function call is on the first line. Up to now we had
been using all the default parameters to <a href="linear.html#dip-Gradient-dip-Image-CL-dip-Image-L-dip-FloatArray--dip-String-CL-dip-StringArray-CL-dip-BooleanArray-CL-dip-dfloat-"><code>dip::Gradient</code></a>, but now we need
to set the <code>process</code> parameter: a boolean array indicating along which
dimensions to compute the derivative. Since this parameter is towards the
end of the parameter list, we must fill out the other default values,
which we simply copied from the function declaration.</p>
<h2 id="diffusion">Anisotropic diffusion</h2>
<p>There are many more examples where per-pixel matrix algebra is useful and
<em>DIPlib</em> allows simple, efficient implementation. The last example we&rsquo;ll
give here is from the function <a href="nonlinear.html#dip-CoherenceEnhancingDiffusion-dip-Image-CL-dip-Image-L-dip-dfloat--dip-dfloat--dip-uint--dip-StringSet-CL"><code>dip::CoherenceEnhancingDiffusion</code></a>.</p>
<p>The diffusion equation can be discretized along the time axis to yield
an iterative update process described by</p>
<div class="m-math"><svg style="width: 12.371em; height: 1.446em;" viewBox="132.1 -14.48 123.71 14.46">
<title>
\[ I^{t+1} = I^t + \lambda \, \mathrm{div} \left( D \, \nabla I^t \right) \; . \]
</title>
<defs>
<use id='eq247-g23-100' xlink:href='#eq247-g20-100' transform='scale(1.36)'/>
<use id='eq247-g23-105' xlink:href='#eq247-g20-105' transform='scale(1.36)'/>
<use id='eq247-g23-118' xlink:href='#eq247-g20-118' transform='scale(1.36)'/>
<path id='eq247-g4-0' d='M3.13 12.48C1.83 11.02 1.64 8.27 1.64 6.06S1.69 1.21 3.13-.43L2.99-.67C2.42-.19 .6 2.12 .6 6.06S2.42 12.26 2.99 12.73L3.13 12.48Z'/>
<path id='eq247-g4-1' d='M.36 12.48L.5 12.73C1.07 12.26 2.89 10 2.89 6.06S1.07-.19 .5-.67L.36-.43C1.8 1.21 1.85 3.86 1.85 6.06S1.66 11.02 .36 12.48Z'/>
<use id='eq247-g10-114' xlink:href='#eq247-g7-114' transform='scale(1.36)'/>
<use id='eq247-g10-184' xlink:href='#eq247-g7-184' transform='scale(1.36)'/>
<path id='eq247-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<path id='eq247-g7-114' d='M5.49-5.9H.27L2.85 0H3.02L5.49-5.9ZM4.77-5.14L3.16-1.27L1.55-5.14H4.77Z'/>
<path id='eq247-g7-184' d='M2.17-2.5H.26V-1.92H2.17V0H2.75V-1.92H4.66V-2.5H2.75V-4.42H2.17V-2.5Z'/>
<path id='eq247-g20-49' d='M3.44 0V-.13C2.75-.14 2.61-.23 2.61-.65V-5.89L2.54-5.9L.97-5.11V-4.99C1.07-5.03 1.17-5.07 1.21-5.08C1.36-5.14 1.51-5.18 1.6-5.18C1.78-5.18 1.86-5.05 1.86-4.77V-.81C1.86-.52 1.79-.32 1.65-.24C1.52-.17 1.4-.14 1.03-.13V0H3.44Z'/>
<path id='eq247-g20-100' d='M4.29-.37V-.51C4.13-.5 4.11-.5 4.09-.5C3.77-.5 3.7-.59 3.7-1V-5.95L3.66-5.97C3.24-5.82 2.93-5.73 2.38-5.58V-5.44C2.45-5.45 2.5-5.45 2.57-5.45C2.89-5.45 2.97-5.36 2.97-5V-3.64C2.64-3.92 2.4-4.02 2.05-4.02C1.05-4.02 .24-3.03 .24-1.79C.24-.67 .89 .09 1.85 .09C2.34 .09 2.67-.09 2.97-.5V.06L3 .09L4.29-.37ZM2.97-.89C2.97-.83 2.91-.72 2.82-.63C2.66-.45 2.45-.37 2.19-.37C1.47-.37 .99-1.07 .99-2.14C.99-3.13 1.41-3.77 2.08-3.77C2.54-3.77 2.97-3.36 2.97-2.9V-.89Z'/>
<path id='eq247-g20-105' d='M2.21 0V-.13C1.63-.17 1.56-.26 1.56-.89V-3.99L1.53-4.02L.17-3.54V-3.41L.24-3.42C.35-3.43 .46-3.44 .54-3.44C.75-3.44 .83-3.3 .83-2.92V-.89C.83-.26 .74-.17 .14-.13V0H2.21ZM1.64-5.52C1.64-5.76 1.45-5.97 1.2-5.97C.95-5.97 .75-5.76 .75-5.52C.75-5.27 .95-5.07 1.2-5.07C1.45-5.07 1.64-5.27 1.64-5.52Z'/>
<path id='eq247-g20-118' d='M4.17-3.8V-3.93H2.95V-3.8C3.23-3.77 3.36-3.69 3.36-3.52C3.36-3.43 3.35-3.35 3.31-3.26L2.45-1L1.55-3.23C1.5-3.35 1.48-3.48 1.48-3.55C1.48-3.71 1.57-3.77 1.88-3.8V-3.93H.17V-3.8C.5-3.78 .56-3.69 .96-2.79L2.01-.29C2.03-.24 2.05-.17 2.08-.1C2.13 .05 2.18 .12 2.24 .12S2.35 .01 2.48-.31L3.6-3.12C3.85-3.71 3.9-3.77 4.17-3.8Z'/>
<path id='eq247-g13-25' d='M6.11-3.35C6.11-4.79 5.12-5.7 3.56-5.7H1.14V-5.56C1.69-5.51 1.81-5.44 1.81-5.21C1.81-5.07 1.77-4.87 1.71-4.65L.64-.79C.48-.28 .42-.23-.07-.14V0H2.14C3.14 0 4.05-.26 4.72-.72C5.59-1.34 6.11-2.32 6.11-3.35ZM5.14-3.56C5.14-2.61 4.78-1.64 4.18-1.05C3.67-.52 2.96-.26 2.05-.26C1.65-.26 1.48-.36 1.48-.59C1.48-.7 1.53-.87 1.68-1.41L2.73-5.19C2.79-5.38 2.91-5.44 3.27-5.44C3.76-5.44 4.18-5.33 4.46-5.14C4.9-4.83 5.14-4.26 5.14-3.56Z'/>
<path id='eq247-g13-30' d='M2.06 0V-.14C1.56-.2 1.47-.25 1.47-.5C1.47-.67 1.48-.76 1.56-1.05L2.64-4.92C2.79-5.42 2.85-5.48 3.35-5.56V-5.7H1.2V-5.56C1.7-5.5 1.81-5.44 1.81-5.19C1.81-5.06 1.78-4.88 1.71-4.65L.64-.79C.48-.28 .42-.23-.07-.14V0H2.06Z'/>
<path id='eq247-g13-67' d='M2.59-3.74H1.89L2.13-4.64C2.14-4.66 2.14-4.67 2.14-4.68C2.14-4.74 2.11-4.77 2.07-4.77C2.02-4.77 1.99-4.76 1.94-4.69C1.11-3.61 .5-3.79 .5-3.51C.5-3.5 .5-3.49 .51-3.46H1.15L.52-1.06C.5-.94 .32-.4 .32-.24C.32-.04 .51 .1 .74 .1C1.14 .1 1.43-.15 1.98-.96L1.87-1.02C1.44-.47 1.3-.33 1.16-.33C1.08-.33 1.03-.4 1.03-.51C1.03-.52 1.03-.52 1.04-.55L1.81-3.46H2.54L2.59-3.74Z'/>
<path id='eq247-g13-95' d='M4.6-.64L4.59-.66C4.47-.66 4.32-.36 3.96-.36C2.31-.36 5.31-5.72 2.74-5.72H2.65C2.49-5.72 2.12-5.59 2.01-5.49C2-5.48 2.07-5.4 2.08-5.4C2.12-5.43 2.31-5.51 2.49-5.51C3.34-5.51 3.11-4.11 3.11-3.89C3.12-3.86 3.11-3.84 3.1-3.81C2.93-3 .35-.71 .14 0H1.01C1.01-.09 1.02-.17 1.04-.27C1.29-1.39 3-3.08 3-3.09H3.01C2.96-2.64 2.17 .1 3.6 .1C3.98 .1 4.59-.53 4.6-.64Z'/>
<path id='eq247-g13-149' d='M1.58-.38C1.58-.65 1.35-.87 1.09-.87S.61-.66 .61-.38C.61-.04 .91 .1 1.09 .1S1.58-.05 1.58-.38Z'/>
<use id='eq247-g16-25' xlink:href='#eq247-g13-25' transform='scale(1.36)'/>
<use id='eq247-g16-30' xlink:href='#eq247-g13-30' transform='scale(1.36)'/>
<use id='eq247-g16-95' xlink:href='#eq247-g13-95' transform='scale(1.36)'/>
<use id='eq247-g16-149' xlink:href='#eq247-g13-149' transform='scale(1.36)'/>
</defs>
<g id='eq247-page1'>
<use x='132.19' y='-3.64' xlink:href='#eq247-g16-30'/>
<use x='137.01' y='-8.57' xlink:href='#eq247-g13-67'/>
<use x='139.96' y='-8.57' xlink:href='#eq247-g7-184'/>
<use x='144.9' y='-8.57' xlink:href='#eq247-g20-49'/>
<use x='153.1' y='-3.64' xlink:href='#eq247-g1-61'/>
<use x='163.99' y='-3.64' xlink:href='#eq247-g16-30'/>
<use x='168.81' y='-8.57' xlink:href='#eq247-g13-67'/>
<use x='174.91' y='-3.64' xlink:href='#eq247-g10-184'/>
<use x='184.15' y='-3.64' xlink:href='#eq247-g16-95'/>
<use x='192.76' y='-3.64' xlink:href='#eq247-g23-100'/>
<use x='198.74' y='-3.64' xlink:href='#eq247-g23-105'/>
<use x='202.06' y='-3.64' xlink:href='#eq247-g23-118'/>
<use x='210.99' y='-12.75' xlink:href='#eq247-g4-0'/>
<use x='215.18' y='-3.64' xlink:href='#eq247-g16-25'/>
<use x='226.64' y='-3.64' xlink:href='#eq247-g10-114'/>
<use x='235.18' y='-3.64' xlink:href='#eq247-g16-30'/>
<use x='240' y='-8.57' xlink:href='#eq247-g13-67'/>
<use x='243.69' y='-12.75' xlink:href='#eq247-g4-1'/>
<use x='253.65' y='-3.64' xlink:href='#eq247-g16-149'/>
</g>
</svg></div>
<p>If <span class="m-math"><svg style="width: 0.843em; height: 0.778em; vertical-align: -0.000em;" viewBox=".35 -7.78 8.43 7.78">
<title>
\(D\)
</title>
<defs>
<path id='eq276-g1-25' d='M8.34-4.57C8.34-6.53 6.98-7.78 4.86-7.78H1.55V-7.59C2.3-7.52 2.47-7.42 2.47-7.1C2.47-6.92 2.42-6.63 2.33-6.34L.87-1.07C.66-.38 .57-.31-.1-.19V0H2.92C4.28 0 5.53-.36 6.43-.99C7.62-1.82 8.34-3.17 8.34-4.57ZM7.02-4.86C7.02-3.56 6.52-2.24 5.71-1.43C5-.71 4.04-.36 2.8-.36C2.25-.36 2.02-.49 2.02-.8C2.02-.95 2.08-1.19 2.29-1.93L3.73-7.07C3.8-7.34 3.97-7.42 4.45-7.42C5.12-7.42 5.71-7.27 6.09-7C6.68-6.59 7.02-5.81 7.02-4.86Z'/>
</defs>
<g id='eq276-page1'>
<use x='.44' y='0' xlink:href='#eq276-g1-25'/>
</g>
</svg></span> is constant (spatially and in time), the above iterative process
leads to Gaussian smoothing. By adjusting <span class="m-math"><svg style="width: 0.843em; height: 0.778em; vertical-align: -0.000em;" viewBox=".35 -7.78 8.43 7.78">
<title>
\(D\)
</title>
<defs>
<path id='eq277-g1-25' d='M8.34-4.57C8.34-6.53 6.98-7.78 4.86-7.78H1.55V-7.59C2.3-7.52 2.47-7.42 2.47-7.1C2.47-6.92 2.42-6.63 2.33-6.34L.87-1.07C.66-.38 .57-.31-.1-.19V0H2.92C4.28 0 5.53-.36 6.43-.99C7.62-1.82 8.34-3.17 8.34-4.57ZM7.02-4.86C7.02-3.56 6.52-2.24 5.71-1.43C5-.71 4.04-.36 2.8-.36C2.25-.36 2.02-.49 2.02-.8C2.02-.95 2.08-1.19 2.29-1.93L3.73-7.07C3.8-7.34 3.97-7.42 4.45-7.42C5.12-7.42 5.71-7.27 6.09-7C6.68-6.59 7.02-5.81 7.02-4.86Z'/>
</defs>
<g id='eq277-page1'>
<use x='.44' y='0' xlink:href='#eq277-g1-25'/>
</g>
</svg></span> to be small at edges,
an anisotropic, edge-enhancing diffusion is obtained. Coherence enhancing
diffusion uses a tensor for <span class="m-math"><svg style="width: 0.843em; height: 0.778em; vertical-align: -0.000em;" viewBox=".35 -7.78 8.43 7.78">
<title>
\(D\)
</title>
<defs>
<path id='eq278-g1-25' d='M8.34-4.57C8.34-6.53 6.98-7.78 4.86-7.78H1.55V-7.59C2.3-7.52 2.47-7.42 2.47-7.1C2.47-6.92 2.42-6.63 2.33-6.34L.87-1.07C.66-.38 .57-.31-.1-.19V0H2.92C4.28 0 5.53-.36 6.43-.99C7.62-1.82 8.34-3.17 8.34-4.57ZM7.02-4.86C7.02-3.56 6.52-2.24 5.71-1.43C5-.71 4.04-.36 2.8-.36C2.25-.36 2.02-.49 2.02-.8C2.02-.95 2.08-1.19 2.29-1.93L3.73-7.07C3.8-7.34 3.97-7.42 4.45-7.42C5.12-7.42 5.71-7.27 6.09-7C6.68-6.59 7.02-5.81 7.02-4.86Z'/>
</defs>
<g id='eq278-page1'>
<use x='.44' y='0' xlink:href='#eq278-g1-25'/>
</g>
</svg></span>. The above-mentioned function allows
to construct this tensor in two ways, starting from (yet again!) the
structure tensor <span class="m-math"><svg style="width: 0.605em; height: 0.816em; vertical-align: -0.022em;" viewBox=".24 -7.94 6.05 8.16">
<title>
\(S\)
</title>
<defs>
<path id='eq279-g1-40' d='M5.13-2.17C5.13-2.94 4.87-3.39 3.79-4.49C2.7-5.57 2.61-5.74 2.61-6.32C2.61-7.07 3.11-7.54 3.92-7.54C4.36-7.54 4.72-7.4 4.97-7.11C5.24-6.81 5.34-6.41 5.36-5.61L5.57-5.57L6.05-7.94H5.78C5.61-7.69 5.5-7.63 5.24-7.63C5.09-7.63 4.94-7.67 4.69-7.77C4.44-7.87 4.05-7.93 3.68-7.93C2.44-7.93 1.56-7.11 1.56-5.94C1.56-5.3 1.74-4.95 2.45-4.19C2.61-4.04 2.76-3.87 2.92-3.69L3.38-3.19C3.94-2.61 4.1-2.3 4.1-1.79C4.1-.88 3.44-.2 2.56-.2C1.56-.2 .82-1.05 .82-2.22C.82-2.3 .82-2.35 .85-2.45L.61-2.48L.2 .18H.42C.5-.1 .63-.21 .87-.21C1-.21 1.17-.17 1.49-.06C2.04 .14 2.36 .21 2.73 .21C4.1 .21 5.13-.81 5.13-2.17Z'/>
</defs>
<g id='eq279-page1'>
<use x='.24' y='0' xlink:href='#eq279-g1-40'/>
</g>
</svg></span>. Here we apply an eigen decomposition, leading
to a full matrix image <span class="m-math"><svg style="width: 0.819em; height: 0.799em; vertical-align: -0.022em;" viewBox="-.48 -7.78 8.19 7.99">
<title>
\(V\)
</title>
<defs>
<path id='eq280-g1-43' d='M8.19-7.59V-7.78H5.98V-7.59C6.52-7.53 6.73-7.41 6.73-7.18S6.52-6.46 6.11-5.76L3.66-1.52L2.87-6.8C2.86-6.86 2.86-6.92 2.86-6.98C2.86-7.38 3.03-7.5 3.78-7.59V-7.78H.91V-7.59C1.57-7.5 1.6-7.47 1.85-5.98L2.86 .21H3.08L7.53-7.11C7.73-7.43 7.92-7.58 8.19-7.59Z'/>
</defs>
<g id='eq280-page1'>
<use x='-.48' y='0' xlink:href='#eq280-g1-43'/>
</g>
</svg></span> (the eigenvectors), and a diagonal matrix
image <span class="m-math"><svg style="width: 0.756em; height: 0.778em; vertical-align: -0.000em;" viewBox=".32 -7.78 7.56 7.78">
<title>
\(E\)
</title>
<defs>
<path id='eq281-g1-26' d='M6.77-1.93L6.57-2.02C6.01-1.25 5.71-.95 5.19-.71C4.75-.51 3.94-.39 3.04-.39C2.37-.39 2.1-.51 2.1-.8C2.1-.94 2.23-1.49 2.53-2.54L2.91-3.91L3.84-3.87C3.87-3.87 3.91-3.87 3.93-3.87C4.35-3.87 4.65-3.8 4.76-3.69C4.82-3.63 4.85-3.53 4.85-3.32C4.85-3.11 4.82-2.97 4.76-2.7L5-2.64L5.81-5.41L5.6-5.46C5.15-4.44 5.03-4.36 3.95-4.32L3.01-4.3L3.8-7.07C3.87-7.34 3.99-7.38 4.67-7.38C6.54-7.38 6.96-7.23 6.96-6.52C6.96-6.36 6.94-6.18 6.93-5.98L7.18-5.96L7.55-7.78H1.63V-7.59C2.37-7.52 2.55-7.42 2.55-7.1C2.55-6.96 2.48-6.57 2.42-6.34L.95-1.07C.74-.38 .66-.31-.01-.19V0H6.03L6.77-1.93Z'/>
</defs>
<g id='eq281-page1'>
<use x='.33' y='0' xlink:href='#eq281-g1-26'/>
</g>
</svg></span> (the eigenvalues):</p>
<div class="m-math"><svg style="width: 6.018em; height: 1.086em;" viewBox="163.78 -10.86 60.18 10.86">
<title>
\[ S = V \, E \, V^T \; . \]
</title>
<defs>
<path id='eq248-g4-26' d='M4.96-1.41L4.82-1.48C4.41-.92 4.18-.7 3.81-.52C3.49-.38 2.89-.29 2.23-.29C1.74-.29 1.54-.38 1.54-.59C1.54-.69 1.63-1.09 1.85-1.86L2.13-2.86L2.81-2.84C2.84-2.84 2.86-2.84 2.88-2.84C3.19-2.84 3.41-2.79 3.49-2.71C3.54-2.66 3.55-2.59 3.55-2.44C3.55-2.28 3.54-2.17 3.49-1.98L3.67-1.94L4.26-3.97L4.11-4C3.77-3.26 3.69-3.2 2.9-3.17L2.21-3.15L2.79-5.19C2.84-5.38 2.93-5.42 3.42-5.42C4.8-5.42 5.1-5.3 5.1-4.78C5.1-4.66 5.09-4.53 5.08-4.38L5.27-4.37L5.54-5.7H1.2V-5.56C1.74-5.51 1.87-5.44 1.87-5.21C1.87-5.1 1.82-4.82 1.77-4.65L.7-.79C.54-.28 .48-.23-.01-.14V0H4.42L4.96-1.41Z'/>
<path id='eq248-g4-40' d='M3.76-1.59C3.76-2.16 3.57-2.49 2.78-3.29C1.98-4.09 1.91-4.21 1.91-4.64C1.91-5.19 2.28-5.53 2.87-5.53C3.2-5.53 3.46-5.42 3.64-5.21C3.84-5 3.91-4.7 3.93-4.11L4.09-4.09L4.44-5.83H4.24C4.11-5.64 4.04-5.6 3.84-5.6C3.73-5.6 3.62-5.62 3.44-5.69C3.26-5.77 2.97-5.82 2.7-5.82C1.79-5.82 1.14-5.21 1.14-4.36C1.14-3.89 1.28-3.63 1.8-3.07C1.91-2.96 2.03-2.84 2.14-2.71L2.48-2.34C2.89-1.91 3-1.69 3-1.31C3-.65 2.52-.15 1.88-.15C1.14-.15 .6-.77 .6-1.62C.6-1.69 .6-1.72 .62-1.8L.45-1.82L.15 .13H.31C.37-.07 .46-.16 .64-.16C.73-.16 .86-.12 1.09-.04C1.49 .1 1.73 .16 2 .16C3 .16 3.76-.59 3.76-1.59Z'/>
<path id='eq248-g4-41' d='M5.53-5.7H.88L.52-4.36L.67-4.32C1.11-5.22 1.39-5.4 2.57-5.4C2.63-5.4 2.69-5.4 2.75-5.4L1.49-.79C1.35-.32 1.14-.18 .57-.14V0H3.1V-.14L2.77-.17C2.41-.19 2.31-.27 2.31-.54C2.31-.65 2.33-.73 2.42-1.05L3.63-5.4H4.11C4.74-5.4 5.02-5.18 5.02-4.69C5.02-4.58 5.01-4.45 5-4.3L5.14-4.28L5.53-5.7Z'/>
<path id='eq248-g4-43' d='M6.01-5.56V-5.7H4.38V-5.56C4.78-5.52 4.93-5.43 4.93-5.27S4.78-4.73 4.48-4.23L2.68-1.12L2.1-4.99C2.1-5.03 2.1-5.07 2.1-5.12C2.1-5.42 2.22-5.5 2.77-5.56V-5.7H.66V-5.56C1.15-5.5 1.17-5.48 1.35-4.38L2.1 .16H2.26L5.52-5.21C5.67-5.45 5.81-5.56 6.01-5.56Z'/>
<path id='eq248-g4-149' d='M1.58-.38C1.58-.65 1.35-.87 1.09-.87S.61-.66 .61-.38C.61-.04 .91 .1 1.09 .1S1.58-.05 1.58-.38Z'/>
<path id='eq248-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<use id='eq248-g7-26' xlink:href='#eq248-g4-26' transform='scale(1.36)'/>
<use id='eq248-g7-40' xlink:href='#eq248-g4-40' transform='scale(1.36)'/>
<use id='eq248-g7-43' xlink:href='#eq248-g4-43' transform='scale(1.36)'/>
<use id='eq248-g7-149' xlink:href='#eq248-g4-149' transform='scale(1.36)'/>
</defs>
<g id='eq248-page1'>
<use x='163.78' y='-.22' xlink:href='#eq248-g7-40'/>
<use x='173.49' y='-.22' xlink:href='#eq248-g1-61'/>
<use x='183.41' y='-.22' xlink:href='#eq248-g7-43'/>
<use x='194.15' y='-.22' xlink:href='#eq248-g7-26'/>
<use x='203.97' y='-.22' xlink:href='#eq248-g7-43'/>
<use x='212.08' y='-5.16' xlink:href='#eq248-g4-41'/>
<use x='221.81' y='-.22' xlink:href='#eq248-g7-149'/>
</g>
</svg></div>
<p>Next we compute <span class="m-math"><svg style="width: 6.062em; height: 1.038em; vertical-align: -0.013em;" viewBox="-.05 -10.24 60.62 10.38">
<title>
\(t = \mathrm{trace}\,E^{-1}\)
</title>
<defs>
<path id='eq282-g4-0' d='M5.01-2V-2.49H.54V-2H5.01Z'/>
<use id='eq282-g14-97' xlink:href='#eq282-g11-97' transform='scale(1.36)'/>
<use id='eq282-g14-99' xlink:href='#eq282-g11-99' transform='scale(1.36)'/>
<use id='eq282-g14-101' xlink:href='#eq282-g11-101' transform='scale(1.36)'/>
<use id='eq282-g14-114' xlink:href='#eq282-g11-114' transform='scale(1.36)'/>
<use id='eq282-g14-116' xlink:href='#eq282-g11-116' transform='scale(1.36)'/>
<path id='eq282-g11-49' d='M3.44 0V-.13C2.75-.14 2.61-.23 2.61-.65V-5.89L2.54-5.9L.97-5.11V-4.99C1.07-5.03 1.17-5.07 1.21-5.08C1.36-5.14 1.51-5.18 1.6-5.18C1.78-5.18 1.86-5.05 1.86-4.77V-.81C1.86-.52 1.79-.32 1.65-.24C1.52-.17 1.4-.14 1.03-.13V0H3.44Z'/>
<path id='eq282-g11-97' d='M3.86-.35V-.58C3.71-.45 3.61-.41 3.48-.41C3.28-.41 3.21-.53 3.21-.92V-2.62C3.21-3.07 3.17-3.31 3.05-3.51C2.86-3.84 2.49-4.02 1.96-4.02C1.51-4.02 1.09-3.9 .85-3.69C.63-3.51 .49-3.26 .49-3.04C.49-2.84 .66-2.66 .86-2.66S1.26-2.84 1.26-3.03C1.26-3.07 1.25-3.11 1.24-3.17C1.22-3.25 1.21-3.32 1.21-3.38C1.21-3.62 1.49-3.81 1.84-3.81C2.27-3.81 2.51-3.55 2.51-3.08V-2.55C1.16-2.01 1.01-1.94 .64-1.61C.45-1.43 .32-1.14 .32-.85C.32-.3 .7 .09 1.24 .09C1.62 .09 1.98-.1 2.52-.55C2.56-.09 2.72 .09 3.07 .09C3.37 .09 3.55-.02 3.86-.35ZM2.51-1.07C2.51-.8 2.46-.72 2.28-.61C2.07-.49 1.83-.42 1.64-.42C1.34-.42 1.09-.72 1.09-1.09V-1.13C1.09-1.64 1.45-1.96 2.51-2.34V-1.07Z'/>
<path id='eq282-g11-99' d='M3.6-1.28L3.48-1.36C3.06-.75 2.74-.54 2.24-.54C1.44-.54 .89-1.24 .89-2.24C.89-3.15 1.37-3.76 2.08-3.76C2.39-3.76 2.51-3.67 2.59-3.35L2.65-3.15C2.72-2.9 2.87-2.75 3.07-2.75C3.29-2.75 3.48-2.92 3.48-3.12C3.48-3.61 2.86-4.02 2.13-4.02C1.72-4.02 1.3-3.86 .95-3.57C.48-3.18 .22-2.58 .22-1.85C.22-.72 .91 .09 1.88 .09C2.25 .09 2.59-.03 2.88-.28C3.14-.49 3.32-.74 3.6-1.28Z'/>
<path id='eq282-g11-101' d='M3.7-1.37L3.56-1.43C3.14-.77 2.77-.52 2.21-.52C1.73-.52 1.36-.74 1.11-1.21C.93-1.55 .86-1.86 .85-2.42H3.54C3.47-2.99 3.38-3.24 3.16-3.52C2.9-3.83 2.5-4.02 2.04-4.02C.96-4.02 .22-3.14 .22-1.87C.22-.66 .85 .09 1.85 .09C2.69 .09 3.34-.43 3.7-1.37ZM2.65-2.7H.86C.96-3.39 1.26-3.7 1.79-3.7S2.53-3.46 2.65-2.7Z'/>
<path id='eq282-g11-114' d='M2.93-3.55C2.93-3.84 2.74-4.02 2.45-4.02C2.08-4.02 1.83-3.82 1.4-3.2V-4L1.35-4.02C.89-3.83 .58-3.71 .06-3.55V-3.41C.18-3.43 .26-3.44 .37-3.44C.59-3.44 .66-3.3 .66-2.92V-.73C.66-.3 .6-.24 .04-.13V0H2.14V-.13C1.55-.16 1.4-.29 1.4-.79V-2.75C1.4-3.03 1.77-3.47 2.01-3.47C2.06-3.47 2.14-3.42 2.24-3.34C2.38-3.21 2.47-3.16 2.59-3.16C2.79-3.16 2.93-3.31 2.93-3.55Z'/>
<path id='eq282-g11-116' d='M2.44-.58L2.32-.67C2.13-.45 1.99-.37 1.8-.37C1.48-.37 1.35-.59 1.35-1.15V-3.65H2.23V-3.93H1.35V-4.94C1.35-5.03 1.33-5.06 1.28-5.06C1.23-4.97 1.17-4.89 1.11-4.81C.79-4.33 .49-4.01 .26-3.88C.17-3.82 .11-3.76 .11-3.71C.11-3.69 .12-3.67 .15-3.65H.61V-1.02C.61-.29 .87 .09 1.38 .09C1.82 .09 2.15-.12 2.44-.58Z'/>
<path id='eq282-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<path id='eq282-g7-26' d='M6.77-1.93L6.57-2.02C6.01-1.25 5.71-.95 5.19-.71C4.75-.51 3.94-.39 3.04-.39C2.37-.39 2.1-.51 2.1-.8C2.1-.94 2.23-1.49 2.53-2.54L2.91-3.91L3.84-3.87C3.87-3.87 3.91-3.87 3.93-3.87C4.35-3.87 4.65-3.8 4.76-3.69C4.82-3.63 4.85-3.53 4.85-3.32C4.85-3.11 4.82-2.97 4.76-2.7L5-2.64L5.81-5.41L5.6-5.46C5.15-4.44 5.03-4.36 3.95-4.32L3.01-4.3L3.8-7.07C3.87-7.34 3.99-7.38 4.67-7.38C6.54-7.38 6.96-7.23 6.96-6.52C6.96-6.36 6.94-6.18 6.93-5.98L7.18-5.96L7.55-7.78H1.63V-7.59C2.37-7.52 2.55-7.42 2.55-7.1C2.55-6.96 2.48-6.57 2.42-6.34L.95-1.07C.74-.38 .66-.31-.01-.19V0H6.03L6.77-1.93Z'/>
<path id='eq282-g7-67' d='M3.53-5.1H2.57L2.91-6.32C2.92-6.35 2.92-6.37 2.92-6.38C2.92-6.47 2.88-6.5 2.82-6.5C2.75-6.5 2.72-6.49 2.64-6.4C1.51-4.92 .68-5.17 .68-4.79C.68-4.78 .68-4.75 .69-4.72H1.57L.71-1.44C.68-1.29 .44-.55 .44-.32C.44-.06 .69 .13 1.01 .13C1.56 .13 1.95-.2 2.7-1.31L2.55-1.39C1.97-.64 1.77-.45 1.58-.45C1.48-.45 1.41-.55 1.41-.69C1.41-.7 1.41-.71 1.42-.75L2.47-4.72H3.47L3.53-5.1Z'/>
</defs>
<g id='eq282-page1'>
<use x='-.05' y='0' xlink:href='#eq282-g7-67'/>
<use x='7.29' y='0' xlink:href='#eq282-g1-61'/>
<use x='17.69' y='0' xlink:href='#eq282-g14-116'/>
<use x='21.01' y='0' xlink:href='#eq282-g14-114'/>
<use x='24.99' y='0' xlink:href='#eq282-g14-97'/>
<use x='30.3' y='0' xlink:href='#eq282-g14-99'/>
<use x='35.61' y='0' xlink:href='#eq282-g14-101'/>
<use x='43.24' y='0' xlink:href='#eq282-g7-26'/>
<use x='51.55' y='-4.34' xlink:href='#eq282-g4-0'/>
<use x='57.13' y='-4.34' xlink:href='#eq282-g11-49'/>
</g>
</svg></span> and <span class="m-math"><svg style="width: 4.958em; height: 1.484em; vertical-align: -0.424em;" viewBox=".32 -10.61 49.58 14.84">
<title>
\(E&#x27; = \frac{1}{t} E^{-1}\)
</title>
<defs>
<path id='eq283-g7-26' d='M4.96-1.41L4.82-1.48C4.41-.92 4.18-.7 3.81-.52C3.49-.38 2.89-.29 2.23-.29C1.74-.29 1.54-.38 1.54-.59C1.54-.69 1.63-1.09 1.85-1.86L2.13-2.86L2.81-2.84C2.84-2.84 2.86-2.84 2.88-2.84C3.19-2.84 3.41-2.79 3.49-2.71C3.54-2.66 3.55-2.59 3.55-2.44C3.55-2.28 3.54-2.17 3.49-1.98L3.67-1.94L4.26-3.97L4.11-4C3.77-3.26 3.69-3.2 2.9-3.17L2.21-3.15L2.79-5.19C2.84-5.38 2.93-5.42 3.42-5.42C4.8-5.42 5.1-5.3 5.1-4.78C5.1-4.66 5.09-4.53 5.08-4.38L5.27-4.37L5.54-5.7H1.2V-5.56C1.74-5.51 1.87-5.44 1.87-5.21C1.87-5.1 1.82-4.82 1.77-4.65L.7-.79C.54-.28 .48-.23-.01-.14V0H4.42L4.96-1.41Z'/>
<path id='eq283-g7-67' d='M2.59-3.74H1.89L2.13-4.64C2.14-4.66 2.14-4.67 2.14-4.68C2.14-4.74 2.11-4.77 2.07-4.77C2.02-4.77 1.99-4.76 1.94-4.69C1.11-3.61 .5-3.79 .5-3.51C.5-3.5 .5-3.49 .51-3.46H1.15L.52-1.06C.5-.94 .32-.4 .32-.24C.32-.04 .51 .1 .74 .1C1.14 .1 1.43-.15 1.98-.96L1.87-1.02C1.44-.47 1.3-.33 1.16-.33C1.08-.33 1.03-.4 1.03-.51C1.03-.52 1.03-.52 1.04-.55L1.81-3.46H2.54L2.59-3.74Z'/>
<path id='eq283-g14-49' d='M3.44 0V-.13C2.75-.14 2.61-.23 2.61-.65V-5.89L2.54-5.9L.97-5.11V-4.99C1.07-5.03 1.17-5.07 1.21-5.08C1.36-5.14 1.51-5.18 1.6-5.18C1.78-5.18 1.86-5.05 1.86-4.77V-.81C1.86-.52 1.79-.32 1.65-.24C1.52-.17 1.4-.14 1.03-.13V0H3.44Z'/>
<path id='eq283-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<path id='eq283-g4-0' d='M5.01-2V-2.49H.54V-2H5.01Z'/>
<path id='eq283-g4-48' d='M2.59-3.59C2.59-3.9 2.28-4.11 2-4.11C1.68-4.11 1.52-3.79 1.43-3.53L.52-.88C.5-.81 .44-.66 .44-.58S.49-.39 .58-.39C.71-.39 .86-.58 .92-.67L2.35-2.93C2.47-3.12 2.59-3.36 2.59-3.59Z'/>
<use id='eq283-g10-26' xlink:href='#eq283-g7-26' transform='scale(1.36)'/>
</defs>
<g id='eq283-page1'>
<use x='.33' y='0' xlink:href='#eq283-g10-26'/>
<use x='8.47' y='-4.34' xlink:href='#eq283-g4-48'/>
<use x='15.07' y='0' xlink:href='#eq283-g1-61'/>
<use x='26.66' y='-4.71' xlink:href='#eq283-g14-49'/>
<rect x='26.66' y='-3.41' height='.67' width='4.38'/>
<use x='27.36' y='4.12' xlink:href='#eq283-g7-67'/>
<use x='32.57' y='0' xlink:href='#eq283-g10-26'/>
<use x='40.88' y='-4.34' xlink:href='#eq283-g4-0'/>
<use x='46.46' y='-4.34' xlink:href='#eq283-g14-49'/>
</g>
</svg></span>,
and re-compose a tensor using these new eigenvalues:</p>
<div class="m-math"><svg style="width: 6.635em; height: 1.086em;" viewBox="160.75 -10.86 66.35 10.86">
<title>
\[ D = V \, E&#x27; \, V^T \; . \]
</title>
<defs>
<path id='eq249-g7-25' d='M6.11-3.35C6.11-4.79 5.12-5.7 3.56-5.7H1.14V-5.56C1.69-5.51 1.81-5.44 1.81-5.21C1.81-5.07 1.77-4.87 1.71-4.65L.64-.79C.48-.28 .42-.23-.07-.14V0H2.14C3.14 0 4.05-.26 4.72-.72C5.59-1.34 6.11-2.32 6.11-3.35ZM5.14-3.56C5.14-2.61 4.78-1.64 4.18-1.05C3.67-.52 2.96-.26 2.05-.26C1.65-.26 1.48-.36 1.48-.59C1.48-.7 1.53-.87 1.68-1.41L2.73-5.19C2.79-5.38 2.91-5.44 3.27-5.44C3.76-5.44 4.18-5.33 4.46-5.14C4.9-4.83 5.14-4.26 5.14-3.56Z'/>
<path id='eq249-g7-26' d='M4.96-1.41L4.82-1.48C4.41-.92 4.18-.7 3.81-.52C3.49-.38 2.89-.29 2.23-.29C1.74-.29 1.54-.38 1.54-.59C1.54-.69 1.63-1.09 1.85-1.86L2.13-2.86L2.81-2.84C2.84-2.84 2.86-2.84 2.88-2.84C3.19-2.84 3.41-2.79 3.49-2.71C3.54-2.66 3.55-2.59 3.55-2.44C3.55-2.28 3.54-2.17 3.49-1.98L3.67-1.94L4.26-3.97L4.11-4C3.77-3.26 3.69-3.2 2.9-3.17L2.21-3.15L2.79-5.19C2.84-5.38 2.93-5.42 3.42-5.42C4.8-5.42 5.1-5.3 5.1-4.78C5.1-4.66 5.09-4.53 5.08-4.38L5.27-4.37L5.54-5.7H1.2V-5.56C1.74-5.51 1.87-5.44 1.87-5.21C1.87-5.1 1.82-4.82 1.77-4.65L.7-.79C.54-.28 .48-.23-.01-.14V0H4.42L4.96-1.41Z'/>
<path id='eq249-g7-41' d='M5.53-5.7H.88L.52-4.36L.67-4.32C1.11-5.22 1.39-5.4 2.57-5.4C2.63-5.4 2.69-5.4 2.75-5.4L1.49-.79C1.35-.32 1.14-.18 .57-.14V0H3.1V-.14L2.77-.17C2.41-.19 2.31-.27 2.31-.54C2.31-.65 2.33-.73 2.42-1.05L3.63-5.4H4.11C4.74-5.4 5.02-5.18 5.02-4.69C5.02-4.58 5.01-4.45 5-4.3L5.14-4.28L5.53-5.7Z'/>
<path id='eq249-g7-43' d='M6.01-5.56V-5.7H4.38V-5.56C4.78-5.52 4.93-5.43 4.93-5.27S4.78-4.73 4.48-4.23L2.68-1.12L2.1-4.99C2.1-5.03 2.1-5.07 2.1-5.12C2.1-5.42 2.22-5.5 2.77-5.56V-5.7H.66V-5.56C1.15-5.5 1.17-5.48 1.35-4.38L2.1 .16H2.26L5.52-5.21C5.67-5.45 5.81-5.56 6.01-5.56Z'/>
<path id='eq249-g7-149' d='M1.58-.38C1.58-.65 1.35-.87 1.09-.87S.61-.66 .61-.38C.61-.04 .91 .1 1.09 .1S1.58-.05 1.58-.38Z'/>
<path id='eq249-g4-48' d='M2.59-3.59C2.59-3.9 2.28-4.11 2-4.11C1.68-4.11 1.52-3.79 1.43-3.53L.52-.88C.5-.81 .44-.66 .44-.58S.49-.39 .58-.39C.71-.39 .86-.58 .92-.67L2.35-2.93C2.47-3.12 2.59-3.36 2.59-3.59Z'/>
<path id='eq249-g1-61' d='M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z'/>
<use id='eq249-g10-25' xlink:href='#eq249-g7-25' transform='scale(1.36)'/>
<use id='eq249-g10-26' xlink:href='#eq249-g7-26' transform='scale(1.36)'/>
<use id='eq249-g10-43' xlink:href='#eq249-g7-43' transform='scale(1.36)'/>
<use id='eq249-g10-149' xlink:href='#eq249-g7-149' transform='scale(1.36)'/>
</defs>
<g id='eq249-page1'>
<use x='160.85' y='-.22' xlink:href='#eq249-g10-25'/>
<use x='173.52' y='-.22' xlink:href='#eq249-g1-61'/>
<use x='183.44' y='-.22' xlink:href='#eq249-g10-43'/>
<use x='194.18' y='-.22' xlink:href='#eq249-g10-26'/>
<use x='202.32' y='-5.16' xlink:href='#eq249-g4-48'/>
<use x='207.11' y='-.22' xlink:href='#eq249-g10-43'/>
<use x='215.22' y='-5.16' xlink:href='#eq249-g7-41'/>
<use x='224.94' y='-.22' xlink:href='#eq249-g10-149'/>
</g>
</svg></div>
<p>Using <em>DIPlib</em> we can write:</p>
<div class="m-code"><pre><span></span><span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">S</span> <span class="o">=</span> <span class="n">dip</span><span class="o">::</span><span class="n">StructureTensor</span><span class="p">(</span> <span class="n">img</span> <span class="p">);</span> <span class="c1">// see above for how this is computed</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">E</span><span class="p">,</span> <span class="n">V</span><span class="p">;</span>
<span class="n">dip</span><span class="o">::</span><span class="n">EigenDecomposition</span><span class="p">(</span> <span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">V</span> <span class="p">);</span>
<span class="n">E</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">E</span><span class="p">;</span>
<span class="n">E</span> <span class="o">/=</span> <span class="n">dip</span><span class="o">::</span><span class="n">Trace</span><span class="p">(</span> <span class="n">E</span> <span class="p">);</span>
<span class="n">dip</span><span class="o">::</span><span class="n">Image</span> <span class="n">D</span> <span class="o">=</span> <span class="n">V</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">dip</span><span class="o">::</span><span class="n">Transpose</span><span class="p">(</span> <span class="n">V</span> <span class="p">);</span>
<span class="n">img</span> <span class="o">+=</span> <span class="n">lambda</span> <span class="o">*</span> <span class="n">dip</span><span class="o">::</span><span class="n">Divergence</span><span class="p">(</span> <span class="n">D</span> <span class="o">*</span> <span class="n">dip</span><span class="o">::</span><span class="n">Gradient</span><span class="p">(</span> <span class="n">img</span> <span class="p">));</span>
</pre></div>

<p>Iterating this bit of code leads to a coherence enhancing diffusion simulation
on the image <code>img</code>.</p>
      </div>
    </div>
  </div>
</article></main>
<div class="m-doc-search" id="search">
  <a href="#!" onclick="return hideSearch()"></a>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-m-8 m-push-m-2">
        <div class="m-doc-search-header m-text m-small">
          <div><span class="m-label m-default">Tab</span> / <span class="m-label m-default">T</span> to search, <span class="m-label m-default">Esc</span> to close</div>
          <div id="search-symbolcount">&hellip;</div>
        </div>
        <div class="m-doc-search-content">
          <form action="https://diplib.org/diplib-docs/#search">
            <input type="search" name="q" id="search-input" placeholder="Loading &hellip;" disabled="disabled" autofocus="autofocus" autocomplete="off" spellcheck="false" />
          </form>
          <noscript class="m-text m-danger m-text-center">Unlike everything else in the docs, the search functionality <em>requires</em> JavaScript. Enable it or <a href="https://google.com/search?q=site:diplib.org+">use an external search engine</a>.</noscript>
          <div id="search-help" class="m-text m-dim m-text-center">
            <p class="m-noindent">Search for symbols, directories, files, pages or modules.
              You can omit any prefix from the symbol or file path; adding a <code>:</code> or
              <code>/</code> suffix lists all members of given symbol or directory.</p>
            <p class="m-noindent">Use <span class="m-label m-dim">&darr;</span> / <span class="m-label m-dim">&uarr;</span> to navigate through the list,
              <span class="m-label m-dim">Enter</span> to go.
              <span class="m-label m-dim">Tab</span> autocompletes common prefix.
              You can copy a link to the result using <span class="m-label m-dim">âŒ˜</span> <span class="m-label m-dim">L</span>,
              or <span class="m-label m-dim">âŒ˜</span> <span class="m-label m-dim">M</span> to copy a Markdown link.</p>
          </div>
          <div id="search-notfound" class="m-text m-warning m-text-center">Sorry, nothing was found.<br />Maybe try a full-text <a href="#" id="search-external" data-search-engine="https://google.com/search?q=site:diplib.org+{query}">search with external engine</a>?</div>
          <ul id="search-results"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="search-v1.js"></script>
<script src="searchdata-v1.js" async="async"></script>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>DIPlib, a library for quantitative image analysis. Documentation compiled with <a href="https://crisluengo.github.io/doxpp/">dox++</a> and styled with <a href="https://mcss.mosra.cz/">m.css</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>